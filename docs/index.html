<!doctype html><html lang="fr"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"><title>Studio TEST — By S.B</title><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://drive.google.com"><link rel="preconnect" href="https://content.googleapis.com"><link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect rx='12' ry='12' width='64' height='64' fill='%23000'/%3E%3Ctext x='50%25' y='54%25' dominant-baseline='middle' text-anchor='middle' fill='%23fff' font-family='Helvetica Neue' font-size='28' font-weight='300'%3EB%3C/text%3E%3C/svg%3E"><link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;600&display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;500&display=swap" rel="stylesheet"><style>:root{--headerH:95px;--border:#e6e8ee}*{box-sizing:border-box}body{margin:0;background:#f6f7fa;color:#111;font:15px/1.6 "Helvetica Neue",Helvetica,Arial,sans-serif}.header-wrap{position:fixed;inset:0 0 auto 0;height:var(--headerH);background:radial-gradient(circle at 20% 20%,#fff 0%,#f9f9f9 60%,#f0f0f0 100%);border-bottom:1px solid rgba(224,192,102,.55);display:flex;align-items:center;justify-content:space-between;padding:0 24px;z-index:100;box-shadow:0 12px 32px rgba(0,0,0,.15)}.brand,.brand a{display:flex;align-items:center;height:100%;text-decoration:none}.brand svg{height:100px;width:auto;display:block}.headerTexts{text-align:right;color:#000}.title{font-family:'Cinzel',serif;font-weight:400;font-size:22px;line-height:1.1;margin:0}.subTitleSmall{font-size:12px;font-weight:500;color:#6b6b6b;letter-spacing:.08em;text-transform:uppercase;margin:4px 0 0 0}.page{padding-top:calc(var(--headerH) + 10px);padding-bottom:60px}.wrap{max-width:2000px;margin:0 40px;padding:0 24px}.grid{display:grid;grid-template-columns:minmax(0,2.1fr) minmax(0,1.2fr);gap:24px;align-items:flex-start}@media(max-width:1200px){.grid{grid-template-columns:1fr}}.signature{position:fixed;left:64px;bottom:1px;font:500 12px/1.4 "Helvetica Neue",Arial,sans-serif;color:#6b6b6b;background:rgba(255,255,255,.7);border:1px solid rgba(0,0,0,.08);border-radius:10px;box-shadow:0 8px 20px rgba(0,0,0,.08);backdrop-filter:blur(6px);padding:10px 14px;z-index:9999;text-align:left;max-width:240px}.signature .legal{margin-top:6px;font-size:11px;color:#7a7a7a}.card{background:#fff;border:1px solid var(--border);border-radius:20px;box-shadow:0 12px 30px rgba(0,0,0,.06);display:flex;flex-direction:column}.viewer{position:relative;aspect-ratio:2048/1265;width:100%;border-radius:20px 20px 0 0;overflow:hidden;background:#eef2f7;display:flex;align-items:center;justify-content:center;touch-action:none}#cvWrap{position:relative;width:100%;height:100%;transform-origin:center center;display:flex;align-items:center;justify-content:center;will-change:transform;transition:transform .1s cubic-bezier(.25,.46,.45,.94)}canvas#cv{width:100%;height:100%;display:block;background:#eef2f7}.model-label{position:absolute;left:50%;bottom:20px;transform:translateX(-50%);padding:12px 18px;border-radius:14px;background:rgba(255,255,255,.96);border:1px solid rgba(0,0,0,.1);backdrop-filter:blur(6px);font:300 21px/1.2 "Helvetica Neue",sans-serif;letter-spacing:.12em;color:#0b0d10;box-shadow:0 10px 24px rgba(0,0,0,.12);white-space:nowrap;max-width:90%;overflow:hidden;text-overflow:ellipsis;text-align:center}.toolbar{border-top:1px solid var(--border);padding:16px 20px;display:flex;justify-content:flex-end;gap:12px;flex-wrap:wrap}.btn3d{cursor:pointer;border:0;border-radius:12px;padding:12px 18px;font:600 15px/1.1 "Helvetica Neue",sans-serif;color:#111;background:#fff;position:relative;isolation:isolate;box-shadow:inset 0 1px 0 rgba(255,255,255,.9),0 6px 16px rgba(0,0,0,.08);transition:transform .1s,box-shadow .15s}.btn3d::before{content:'';position:absolute;inset:0;border-radius:12px;padding:2px;background:conic-gradient(from 210deg,#dfe7f4,#a8b9d0,#6f87a6,#e9f0fb,#8aa3c7,#dfe7f4);-webkit-mask:linear-gradient(#000 0 0) content-box,linear-gradient(#000 0 0);-webkit-mask-composite:xor;mask-composite:exclude;pointer-events:none}.btn3d:hover{transform:translateY(-1px);box-shadow:0 10px 26px rgba(0,0,0,.15)}.side{display:flex;flex-direction:column;gap:16px;max-height:calc(100vh - var(--headerH) - 40px);overflow-y:auto;padding-right:4px}.panel{background:#fff;border:1px solid var(--border);border-radius:18px;padding:16px 16px 20px;box-shadow:0 12px 30px rgba(0,0,0,.06)}.panelHeader{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}.panelHeader h2{margin:0;font:600 18px/1 'Montserrat',sans-serif;color:#111}.gal{display:grid;grid-template-columns:repeat(5,minmax(0,1fr));gap:10px}@media(min-width:1400px){.gal{grid-template-columns:repeat(5,1fr)}}@media(max-width:600px){.gal{grid-template-columns:repeat(2,1fr)}}.thumb{position:relative;width:100%;aspect-ratio:1/1;border-radius:14px;background:radial-gradient(circle at 0 0,#fff,#e2e8f0);box-shadow:0 10px 20px rgba(148,163,184,.55),0 0 0 1px rgba(148,163,184,.3) inset;overflow:hidden;cursor:pointer;transition:transform .16s,filter .16s;display:flex;align-items:center;justify-content:center}.thumb:hover{transform:translateY(-2px);filter:brightness(1.05)}.thumbImg{position:absolute;inset:0;background-size:cover;background-position:center;background-repeat:no-repeat}.thumbLabel{position:absolute;left:3px;bottom:3px;right:1px;font:600 14px/1.3 'Montserrat',sans-serif;letter-spacing:.06em;text-align:left;z-index:2;text-shadow:0 2px 4px rgba(0,0,0,.6);color:#000}.thumbClose{position:absolute;top:8px;right:8px;width:16px;height:16px;border-radius:4px;background:rgba(0,0,0,.55);color:#fff;font-size:10px;line-height:16px;text-align:center;font-weight:600;cursor:pointer;z-index:3;box-shadow:0 2px 4px rgba(0,0,0,.45)}.thumb[aria-selected="true"]{transform:translateY(-2px)}.thumb[aria-selected="true"]::before{content:'';position:absolute;z-index:2;inset:-5px;border-radius:18px;padding:9px;background:conic-gradient(from 210deg,#fff9df,#f4e0a1,#e2c369,#c79b3f,#eacf86,#f7e9b7,#fff9df);-webkit-mask:linear-gradient(#000 0 0) content-box,linear-gradient(#000 0 0);-webkit-mask-composite:xor;mask-composite:exclude;box-shadow:0 0 0 2px rgba(199,155,63,.95) inset,0 10px 22px rgba(184,148,62,.45);pointer-events:none}.thumb[aria-selected="true"]::after{content:'';position:absolute;z-index:1;inset:0;border-radius:12px;background:radial-gradient(120% 60% at 15% 0%,rgba(255,255,255,.38) 0%,rgba(255,255,255,0) 60%);box-shadow:inset 0 0 0 3px rgba(224,192,102,.95);pointer-events:none}.thumb[aria-selected="true"] .thumbImg{filter:saturate(1.08) contrast(1.06)}@media (prefers-reduced-motion:no-preference){.thumb[aria-selected="true"]::before{animation:goldSheen 3s linear infinite}@keyframes goldSheen{0%{filter:hue-rotate(0deg) brightness(1)}50%{filter:hue-rotate(-8deg) brightness(1.06)}100%{filter:hue-rotate(0deg) brightness(1)}}}.note{margin:10px 0 20px 20px;font:600 12px 'Montserrat',sans-serif;color:#8a8f9a;visibility:hidden}.toast{position:fixed;left:50%;bottom:40px;transform:translateX(-50%);background:rgba(255,255,255,.95);border:1px solid rgba(0,0,0,.1);border-radius:12px;padding:12px 22px;font:600 15px 'Montserrat',sans-serif;color:#000;box-shadow:0 4px 20px rgba(0,0,0,.15);opacity:0;pointer-events:none;transition:opacity .4s;z-index:9999}.toast.show{opacity:1}@media (max-width:1024px){.header-wrap{position:static;height:auto;padding:10px 16px;flex-wrap:wrap;row-gap:8px}.page{padding-top:24px}.grid{grid-template-columns:1fr;gap:24px}.signature{bottom:10px}}@media (max-width:640px){body{font-size:14px}.brand svg{height:48px}.headerTexts{text-align:left;margin-top:6px}.title{font-size:18px}.toolbar{flex-direction:column;align-items:stretch}.signature{left:50%;transform:translateX(-50%);max-width:calc(100% - 20px);text-align:center}}</style></head><body><header class="header-wrap"><div class="headerTexts"><h1 class="title">Studio TEST - By S.B</h1><div class="subTitleSmall">Configuration monture • rendu photo-réaliste</div></div></header><div class="page"><div class="wrap"><div class="grid"><div class="card"><div class="viewer" id="viewer"><div id="cvWrap"><canvas id="cv" width="2048" height="1265"></canvas></div><div class="model-label" id="modelLabel">—</div></div><div class="toolbar"><button class="btn3d" id="btnFav">❤ Favoris</button><button class="btn3d" id="btnShare">⇪ Partager</button><button class="btn3d" id="btnExport">⬇ Exporter</button></div><p class="note" id="driveNote">...</p></div><aside class="side"><div class="panel"><div class="panelHeader"><h2>Faces</h2></div><div id="galFaces" class="gal"></div></div><div class="panel"><div class="panelHeader"><h2>Branches</h2></div><div id="galTemples" class="gal"></div></div><div class="panel"><div class="panelHeader"><h2>Favoris</h2></div><div id="galFavs" class="gal"></div></div></aside></div></div></div><div class="signature">Sébastien BOURDON<br>sb.optic1@gmail.com<br>06&nbsp;62&nbsp;71&nbsp;27&nbsp;52<div class="legal">© 2025 — Usage individuel uniquement</div></div><div id="toast" class="toast">⭐ Ajouté aux favoris</div><script>const DRIVE={API_KEY:"AIzaSyAGTWwPZRyT6P8G2FlfeCRPnlADalQmE-0",FACES_FOLDER_ID:"1sYQqBv9T_CFFeJBS_9otKVz6Q1HONoBx",TEMPLES_FOLDER_ID:"1Uorpg-crCvjlAsYq4Lky2yGRxV2iWwEf",WORKER_URL:"https://berecllo-proxy1.sb-optic1.workers.dev",FACE_MASK_FILE_ID:"1kPVvpTxjyyYZhivVWLrgtG8yHzc8Qrj5",DIRECT_FALLBACK:!0,CONCURRENCY:5},cv=document.getElementById("cv"),ctx=cv.getContext("2d",{willReadFrequently:!0}),cvWrap=document.getElementById("cvWrap"),modelLabel=document.getElementById("modelLabel"),viewer=document.getElementById("viewer"),galFaces=document.getElementById("galFaces"),galTemples=document.getElementById("galTemples"),galFavs=document.getElementById("galFavs"),btnFav=document.getElementById("btnFav"),btnShare=document.getElementById("btnShare"),btnExport=document.getElementById("btnExport"),driveNote=document.getElementById("driveNote"),toast=document.getElementById("toast"),state={faces:[],temples:[],selFace:null,selTemples:null,favs:[],tol:60,zoomScale:1,dbReady:!1,dbFailed:!1};let db;const DB_NAME="berecllo-store",DB_VER=4;function openDB(){return new Promise((e,t)=>{try{const n=indexedDB.open(DB_NAME,DB_VER);n.onupgradeneeded=e=>{const t=e.target.result;t.objectStoreNames.contains("images")||t.createObjectStore("images",{keyPath:"id"}),t.objectStoreNames.contains("meta")||t.createObjectStore("meta",{keyPath:"key"})},n.onsuccess=()=>{db=n.result,state.dbReady=!0,e(db)},n.onerror=()=>{state.dbFailed=!0,t(n.error)}}catch(e){state.dbFailed=!0,t(e)}})}function idFor(e,t){return`${e}|${t}`}function putImageRecord(e,t,n,a,o,r){if(state.dbFailed||!state.dbReady||!db)return Promise.resolve();const i=db.transaction("images","readwrite");return i.objectStore("images").put({id:idFor(e,t),name:t,type:e,blob:n,modified:a||null,thumbDataURL:o||null,textColor:r||null}),new Promise(e=>i.oncomplete=e)}function deleteImageRecord(e,t){if(state.dbFailed||!state.dbReady||!db)return Promise.resolve();const n=db.transaction("images","readwrite");return n.objectStore("images").delete(idFor(e,t)),new Promise(e=>n.oncomplete=e)}function getAllImages(){return state.dbFailed||!state.dbReady||!db?Promise.resolve([]):new Promise((e,t)=>{const n=db.transaction("images","readonly").objectStore("images").getAll();n.onsuccess=()=>e(n.result||[]),n.onerror=()=>t(n.error)})}function saveMeta(e,t){if(state.dbFailed||!state.dbReady||!db)return Promise.resolve();const n=db.transaction("meta","readwrite");return n.objectStore("meta").put({key:e,value:t}),new Promise(e=>n.oncomplete=e)}function loadMeta(e){return state.dbFailed||!state.dbReady||!db?Promise.resolve(null):new Promise(t=>{const n=db.transaction("meta","readonly").objectStore("meta").get(e);n.onsuccess=()=>t(n.result?n.result.value:null),n.onerror=()=>t(null)})}function breathe(){return new Promise(e=>setTimeout(e,0))}function imgFromBlob(e){return new Promise((t,n)=>{const a=new Image;a.onload=()=>t(a),a.onerror=n,a.src=URL.createObjectURL(e)})}function faceLabel(e){return e.replace(/\.[^.]+$/,"").toUpperCase()}function templesLabel(e){return e.replace(/\.[^.]+$/,"").toLowerCase()}function slugifyForFilename(e){return(e||"berecllo").normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^\w\- ]+/g,"").replace(/\s+/g,"_").replace(/_+/g,"_").replace(/^_+|_+$/g,"")}function apiDownloadURL(e){return"https://drive.google.com/uc?export=download&id="+encodeURIComponent(e)}function proxyURL(e){return DRIVE.WORKER_URL+"?u="+encodeURIComponent(e)}function apiListURL(e){const t=new URLSearchParams({key:DRIVE.API_KEY,q:`'${e}' in parents and trashed=false`,fields:"files(id,name,mimeType,modifiedTime)",pageSize:1e3});return"https://www.googleapis.com/drive/v3/files?"+t.toString()}async function fetchJSONfallback(e){try{const t=await fetch(proxyURL(e),{mode:"cors",headers:{"Content-Type":"application/json"},cache:"no-store"});if(!t.ok)throw new Error("proxy json "+t.status);return await t.json()}catch(t){if(!DRIVE.DIRECT_FALLBACK)throw t;const n=await fetch(e,{mode:"cors",cache:"no-store"});if(!n.ok)throw new Error("direct json "+n.status);return await n.json()}}async function fetchBLOBfallback(e){try{const t=await fetch(proxyURL(e),{mode:"cors",cache:"no-store"});if(!t.ok)throw new Error("proxy blob "+t.status);return await t.blob()}catch(t){if(!DRIVE.DIRECT_FALLBACK)throw t;const n=await fetch(e,{mode:"cors",cache:"no-store"});if(!n.ok)throw new Error("direct blob "+n.status);return await n.blob()}}let faceMaskImg=null,faceMaskReady=!1;const workerCode=`self.onmessage=function(e){const{d:n,w:t,h:a,tol:o}=e.data,r=Math.floor(Math.min(t,a)*.03),s=10;let l=0,c=0,i=0,d=0;function u(e,r){const o=(r*t+e)*4;l+=n[o],c+=n[o+1],i+=n[o+2],d++}for(let e=0;e<=s;e++){const a=Math.floor(e*(t-1)/s),o=Math.floor(e*(a-1)/s);u(a,r),u(a,a-1-r),u(r,o),u(t-1-r,o)}l/=d,c/=d,i/=d;for(let e=0;e<n.length;e+=4){const t=n[e]-l,a=n[e+1]-c,r=n[e+2]-i;Math.sqrt(t*t+a*a+r*r)<o&&(n[e+3]=0)}self.postMessage(n,[n.buffer])};`,blobWorker=new Blob([workerCode],{type:"application/javascript"}),workerUrl=URL.createObjectURL(blobWorker),bgWorker=new Worker(workerUrl);async function loadFaceMaskFromDrive(){if(DRIVE.FACE_MASK_FILE_ID)try{const e=await fetchBLOBfallback(apiDownloadURL(DRIVE.FACE_MASK_FILE_ID));faceMaskImg=await imgFromBlob(e),faceMaskReady=!0}catch(e){console.warn("Mask fail",e)}}function removeBackgroundAuto(e,t){return new Promise(n=>{const a=e.naturalWidth||e.width,o=e.naturalHeight||e.height,r=document.createElement("canvas");r.width=a,r.height=o;const i=r.getContext("2d",{willReadFrequently:!0});if(faceMaskReady&&faceMaskImg){i.drawImage(e,0,0),i.globalCompositeOperation="destination-in",i.drawImage(faceMaskImg,0,0,a,o);const t=new Image;return t.onload=()=>n(t),void(t.src=r.toDataURL())}i.drawImage(e,0,0);const s=i.getImageData(0,0,a,o),l=e=>{bgWorker.removeEventListener("message",l),i.putImageData(new ImageData(new Uint8ClampedArray(e.data),a,o),0,0),createImageBitmap(r).then(e=>n(e))};bgWorker.addEventListener("message",l),bgWorker.postMessage({d:s.data,w:a,h:o,tol:t},[s.data.buffer])})}function makeThumbInfo(e){const t=200,n=document.createElement("canvas");n.width=t,n.height=t;const a=n.getContext("2d"),o=e.naturalWidth||e.width,r=e.naturalHeight||e.height,i=o/r;let s,l,c,d;i>1?(d=r,c=r,s=(o-c)/2,l=0):(c=o,d=o,s=0,l=(r-d)/2),a.drawImage(e,s,l,c,d,0,0,t,t);const u=a.getImageData(0,0,t,t).data;let m=0,f=0,g=0,p=0;for(let e=0;e<u.length;e+=4)m+=u[e],f+=u[e+1],g+=u[e+2],p++;return{thumbDataURL:n.toDataURL("image/jpeg",.8),textColor:.299*(m/p)+.587*(f/p)+.114*(g/p)<140?"#fff":"#000"}}function updateLabel(){const e=state.selFace?faceLabel(state.selFace.name):"",t=state.selTemples?templesLabel(state.selTemples.name):"";modelLabel.textContent=e&&t?`${e} - ${t}`:e||t||"—"}function redraw(){ctx.clearRect(0,0,cv.width,cv.height),state.selTemples?.img&&ctx.drawImage(state.selTemples.img,0,0,cv.width,cv.height),state.selFace?.proc&&ctx.drawImage(state.selFace.proc,0,0,cv.width,cv.height),updateLabel(),persistSelection().catch(()=>{})}function selectAndRedraw(e,t){e?state.selFace=t:state.selTemples=t,redraw(),rebuildAllGalleries()}async function removeVariant(e,t){const n=e?state.faces:state.temples,a=n.findIndex(e=>e.name===t);a>=0&&(n.splice(a,1),e&&state.selFace?.name===t&&(state.selFace=null),!e&&state.selTemples?.name===t&&(state.selTemples=null)),await deleteImageRecord(e?"face":"temples",t),await persistLists(),redraw(),rebuildAllGalleries()}function buildThumbEl(e,t){const n=document.createElement("div");n.className="thumb",n.setAttribute("aria-selected",e?state.selFace===t:state.selTemples===t?"true":"false");const a=document.createElement("div");a.className="thumbInnerBorder",n.appendChild(a);const o=document.createElement("div");o.className="thumbImg",t.thumbDataURL?o.style.backgroundImage=`url("${t.thumbDataURL}")`:o.style.backgroundColor="#ddd",n.appendChild(o);const r=document.createElement("div");r.className="thumbLabel",r.style.color=t.textColor||"#000",r.textContent=e?faceLabel(t.name):templesLabel(t.name),n.appendChild(r);const i=document.createElement("div");return i.className="thumbClose",i.textContent="✕",i.onclick=n=>{n.stopPropagation(),removeVariant(e,t.name)},n.appendChild(i),n.onclick=()=>selectAndRedraw(e,t),n}function rebuildGallery(e,t,n){e.innerHTML="";[...t].sort((e,t)=>e.name.localeCompare(t.name,void 0,{numeric:!0,sensitivity:"base"})).forEach(t=>e.appendChild(buildThumbEl(n,t)))}async function generateComboThumb(e,t){if(!e||!t)return null;const n=document.createElement("canvas");n.width=300,n.height=185;const a=n.getContext("2d");return t.img&&a.drawImage(t.img,0,0,300,185),e.proc&&a.drawImage(e.proc,0,0,300,185),n.toDataURL("image/jpeg",.7)}async function renderFavs(){galFavs.innerHTML="";for(const e of state.favs){const t=state.faces.find(t=>t.name===e.face),n=state.temples.find(t=>t.name===e.temples),a=document.createElement("div");a.className="thumb",a.setAttribute("aria-selected","false");const o=document.createElement("div");o.className="thumbInnerBorder",a.appendChild(o);const r=document.createElement("div");if(r.className="thumbImg",t&&n){const e=await generateComboThumb(t,n);r.style.backgroundImage=`url("${e}")`}else t&&t.thumbDataURL?r.style.backgroundImage=`url("${t.thumbDataURL}")`:r.style.backgroundColor="#ccc";a.appendChild(r);const i=document.createElement("div");i.className="thumbLabel",i.style.color="#000",i.textContent=e.label,i.style.textShadow="0 2px 4px rgba(255,255,255,0.8)",a.appendChild(i),a.onclick=()=>{t&&(state.selFace=t),n&&(state.selTemples=n),redraw(),rebuildAllGalleries()},galFavs.appendChild(a)}}function rebuildAllGalleries(){rebuildGallery(galFaces,state.faces,!0),rebuildGallery(galTemples,state.temples,!1),renderFavs()}function toastMsg(e){toast.textContent=e,toast.classList.add("show"),setTimeout(()=>toast.classList.remove("show"),1400)}async function persistLists(){await saveMeta("facesNames",state.faces.map(e=>e.name)),await saveMeta("templesNames",state.temples.map(e=>e.name))}async function persistSelection(){await saveMeta("selection",{face:state.selFace?.name,temples:state.selTemples?.name})}async function processInBatches(e,t,n){for(let a=0;a<e.length;a+=t){const o=e.slice(a,a+t);await Promise.all(o.map(n)),await breathe()}}async function syncFolder(e,t){driveNote.textContent=`Maj ${"face"===e?"Faces":"Branches"}...`;let n=[];try{n=(await fetchJSONfallback(apiListURL(t))).files||[]}catch(t){return void console.warn("List fail",e)}const a="face"===e?state.faces:state.temples,o=new Set(n.map(e=>e.name||e.id+".png"));let r=!1;for(let t=a.length-1;t>=0;t--)if(!o.has(a[t].name)){const n=a[t].name;a.splice(t,1),deleteImageRecord(e,n),r=!0}r&&rebuildAllGalleries();const i=n.filter(e=>{const t=e.name||e.id+".png",n=a.find(e=>e.name===t);return!n||n.modified!==e.modifiedTime});await processInBatches(i,DRIVE.CONCURRENCY,async n=>{const o=n.name||n.id+".png";try{const r=await fetchBLOBfallback(apiDownloadURL(n.id));await integrateDriveFile(e,o,r,n.modifiedTime),"face"===e?rebuildGallery(galFaces,state.faces,!0):rebuildGallery(galTemples,state.temples,!1)}catch(e){console.warn("DL error",o)}}),await persistLists(),driveNote.textContent=""}async function integrateDriveFile(e,t,n,a){const o=await imgFromBlob(n),{thumbDataURL:r,textColor:i}=makeThumbInfo(o);if("face"===e){await breathe();const s=await removeBackgroundAuto(o,state.tol),l={name:t,img:o,proc:s,modified:a,thumbDataURL:r,textColor:i};state.faces.findIndex(e=>e.name===t)>=0?state.faces[state.faces.findIndex(e=>e.name===t)]=l:state.faces.push(l),state.selFace?.name===t&&redraw()}else{const s={name:t,img:o,modified:a,thumbDataURL:r,textColor:i};state.temples.findIndex(e=>e.name===t)>=0?state.temples[state.temples.findIndex(e=>e.name===t)]=s:state.temples.push(s)}putImageRecord(e,t,n,a,r,i).catch(()=>{})}async function reloadFromIndexedDB(){const e=await getAllImages().catch(()=>[]),t=await loadMeta("facesNames")||[],n=await loadMeta("templesNames")||[],a=await loadMeta("selection")||{};state.favs=await loadMeta("favs")||[];const o={};for(const t of e)o[idFor(t.type,t.name)]=t;for(const e of t){const t=o[idFor("face",e)];if(!t)continue;const n=await imgFromBlob(t.blob);if(!t.thumbDataURL){const e=makeThumbInfo(n);t.thumbDataURL=e.thumbDataURL,t.textColor=e.textColor,putImageRecord("face",e,t.blob,t.modified,e.thumbDataURL,e.textColor)}await breathe();const a=await removeBackgroundAuto(n,state.tol);state.faces.push({name:e,img:n,proc:a,modified:t.modified,thumbDataURL:t.thumbDataURL,textColor:t.textColor})}for(const e of n){const t=o[idFor("temples",e)];if(!t)continue;const n=await imgFromBlob(t.blob);t.thumbDataURL||(t=makeThumbInfo(n),t.thumbDataURL=t.thumbDataURL,t.textColor=t.textColor,putImageRecord("temples",e,t.blob,t.modified,t.thumbDataURL,t.textColor)),state.temples.push({name:e,img:n,modified:t.modified,thumbDataURL:t.thumbDataURL,textColor:t.textColor})}a.face&&(state.selFace=state.faces.find(e=>e.name===a.face)),a.temples&&(state.selTemples=state.temples.find(e=>e.name===a.temples)),rebuildAllGalleries(),redraw()}btnExport.onclick=()=>cv.toBlob(e=>{const t=document.createElement("a");t.href=URL.createObjectURL(e),t.download=slugifyForFilename(modelLabel.textContent)+".png",t.click()}),btnShare.onclick=()=>cv.toBlob(async e=>{const t=new File([e],slugifyForFilename(modelLabel.textContent)+".png",{type:"image/png"});if(navigator.canShare?.({files:[t]}))try{await navigator.share({files:[t],title:"Berecllo"})}catch(e){}}),btnFav.onclick=async()=>{if(!state.selFace||!state.selTemples)return;const e=modelLabel.textContent;state.favs.find(e=>e.face===state.selFace.name&&e.temples===state.selTemples.name)||(state.favs.unshift({face:state.selFace.name,temples:state.selTemples.name,label:e}),state.favs.length>5&&state.favs.pop(),await saveMeta("favs",state.favs),renderFavs(),toastMsg("⭐ Ajouté"))},viewer.addEventListener("wheel",e=>{e.preventDefault(),state.zoomScale+=e.deltaY<0?.1:-.1,state.zoomScale=Math.min(Math.max(state.zoomScale,1),2.5),cvWrap.style.transform=`scale(${state.zoomScale})`},{passive:!1}),(async function(){await openDB().catch(console.error),await loadFaceMaskFromDrive(),await reloadFromIndexedDB(),Promise.all([syncFolder("temples",DRIVE.TEMPLES_FOLDER_ID),syncFolder("face",DRIVE.FACES_FOLDER_ID)]).then(()=>console.log("Synchro terminée"))})();</script></body></html>
