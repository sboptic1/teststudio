<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Studio TEST — By S.B</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="preconnect" href="https://drive.google.com">
<link rel="preconnect" href="https://content.googleapis.com">
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect rx='12' ry='12' width='64' height='64' fill='%23000'/%3E%3Ctext x='50%25' y='54%25' dominant-baseline='middle' text-anchor='middle' fill='%23fff' font-family='Helvetica Neue' font-size='28' font-weight='300'%3EB%3C/text%3E%3C/svg%3E">
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;600&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;500&display=swap" rel="stylesheet">
<style>
:root{--headerH:95px;--border:#e6e8ee}
*{box-sizing:border-box}
body{margin:0;background:#f6f7fa;color:#111;font:15px/1.6 "Helvetica Neue",Helvetica,Arial,sans-serif}
.header-wrap{position:fixed;inset:0 0 auto 0;height:var(--headerH);background:radial-gradient(circle at 20% 20%,#fff 0%,#f9f9f9 60%,#f0f0f0 100%);border-bottom:1px solid rgba(224,192,102,.55);display:flex;align-items:center;justify-content:space-between;padding:0 24px;z-index:100;box-shadow:0 12px 32px rgba(0,0,0,.15)}
.brand{display:flex;align-items:center;height:100%}
.brand a{display:flex;align-items:center;height:100%;text-decoration:none}
.brand svg{height:100px;width:auto;display:block}
.headerTexts{text-align:right;color:#000}
.title{font-family:'Cinzel',serif;font-weight:400;font-size:22px;line-height:1.1;margin:0}
.subTitleSmall{font-size:12px;font-weight:500;color:#6b6b6b;letter-spacing:.08em;text-transform:uppercase;margin:4px 0 0 0}
.page{padding-top:calc(var(--headerH) + 10px);padding-bottom:60px}
.wrap{max-width:2000px;margin:0 40px;padding:0 24px}
.grid{display:grid;grid-template-columns:minmax(0,2.1fr) minmax(0,1.2fr);gap:24px;align-items:flex-start}
@media(max-width:1200px){.grid{grid-template-columns:1fr}}
.signature{position:fixed;left:64px;bottom:1px;font:500 12px/1.4 "Helvetica Neue",Arial,sans-serif;color:#6b6b6b;background:rgba(255,255,255,.7);border:1px solid rgba(0,0,0,.08);border-radius:10px;box-shadow:0 8px 20px rgba(0,0,0,.08);backdrop-filter:blur(6px);padding:10px 14px;z-index:9999;text-align:left;max-width:240px}
.signature .legal{margin-top:6px;font-size:11px;color:#7a7a7a}
.card{background:#fff;border:1px solid var(--border);border-radius:20px;box-shadow:0 12px 30px rgba(0,0,0,.06);display:flex;flex-direction:column}
.viewer{position:relative;aspect-ratio:2048/1265;width:100%;border-radius:20px 20px 0 0;overflow:hidden;background:#eef2f7;display:flex;align-items:center;justify-content:center;touch-action:none}
#cvWrap{position:relative;width:100%;height:100%;transform-origin:center center;display:flex;align-items:center;justify-content:center}
canvas#cv{width:100%;height:100%;display:block;background:#eef2f7}
.model-label{position:absolute;left:50%;bottom:20px;transform:translateX(-50%);padding:12px 18px;border-radius:14px;background:rgba(255,255,255,.96);border:1px solid rgba(0,0,0,.1);backdrop-filter:blur(6px);font:300 21px/1.2 "Helvetica Neue",sans-serif;letter-spacing:.12em;color:#0b0d10;box-shadow:0 10px 24px rgba(0,0,0,.12);white-space:nowrap;max-width:90%;overflow:hidden;text-overflow:ellipsis;text-align:center}
.loader-overlay{position:absolute;right:20px;top:20px;width:30px;height:30px;background:rgba(255,255,255,.9);border-radius:50%;box-shadow:0 2px 10px rgba(0,0,0,.1);display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .2s;z-index:10}
.loader-overlay.active{opacity:1}
.spinner{width:16px;height:16px;border:2px solid #e1e1e1;border-top:2px solid #c79b3f;border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
.toolbar{border-top:1px solid var(--border);padding:16px 20px;display:flex;justify-content:flex-end;gap:12px;flex-wrap:wrap}
.btn3d{cursor:pointer;border:0;border-radius:12px;padding:12px 18px;font:600 15px/1.1 "Helvetica Neue",sans-serif;color:#111;background:#fff;position:relative;isolation:isolate;box-shadow:inset 0 1px 0 rgba(255,255,255,.9),0 6px 16px rgba(0,0,0,.08);transition:transform .1s,box-shadow .15s}
.btn3d::before{content:'';position:absolute;inset:0;border-radius:12px;padding:2px;background:conic-gradient(from 210deg,#dfe7f4,#a8b9d0,#6f87a6,#e9f0fb,#8aa3c7,#dfe7f4);-webkit-mask:linear-gradient(#000 0 0) content-box,linear-gradient(#000 0 0);-webkit-mask-composite:xor;mask-composite:exclude;pointer-events:none}
.btn3d:hover{transform:translateY(-1px);box-shadow:0 10px 26px rgba(0,0,0,.15)}
.side{display:flex;flex-direction:column;gap:16px;max-height:calc(100vh - var(--headerH) - 40px);overflow-y:auto;padding-right:4px}
.panel{background:#fff;border:1px solid var(--border);border-radius:18px;padding:16px 16px 20px;box-shadow:0 12px 30px rgba(0,0,0,.06)}
.panelHeader{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
.panelHeader h2{margin:0;font:600 18px/1 'Montserrat',sans-serif;color:#111}
.gal{display:grid;grid-template-columns:repeat(5,minmax(0,1fr));gap:10px}
@media(min-width:1400px){.gal{grid-template-columns:repeat(5,1fr)}}
@media(max-width:600px){.gal{grid-template-columns:repeat(2,1fr)}}
.thumb{position:relative;width:100%;aspect-ratio:1/1;border-radius:14px;background:radial-gradient(circle at 0 0,#fff,#e2e8f0);box-shadow:0 10px 20px rgba(148,163,184,.55),0 0 0 1px rgba(148,163,184,.3) inset;overflow:hidden;cursor:pointer;transition:transform .16s,filter .16s;display:flex;align-items:center;justify-content:center}
.thumb:hover{transform:translateY(-2px);filter:brightness(1.05)}
.thumbImg{position:absolute;inset:0;background-size:cover;background-position:center;background-repeat:no-repeat}
.thumbLabel{position:absolute;left:3px;bottom:3px;right:1px;font:600 14px/1.3 'Montserrat',sans-serif;letter-spacing:.06em;text-align:left;z-index:2;text-shadow:0 2px 4px rgba(0,0,0,.6);color:#000}
.thumbClose{position:absolute;top:8px;right:8px;width:16px;height:16px;border-radius:4px;background:rgba(0,0,0,.55);color:#fff;font-size:10px;line-height:16px;text-align:center;font-weight:600;cursor:pointer;z-index:3;box-shadow:0 2px 4px rgba(0,0,0,.45)}
.thumb[aria-selected="true"]{transform:translateY(-2px)}
.thumb[aria-selected="true"]::before{content:'';position:absolute;z-index:2;inset:-5px;border-radius:18px;padding:9px;background:conic-gradient(from 210deg,#fff9df,#f4e0a1,#e2c369,#c79b3f,#eacf86,#f7e9b7,#fff9df);-webkit-mask:linear-gradient(#000 0 0) content-box,linear-gradient(#000 0 0);-webkit-mask-composite:xor;mask-composite:exclude;box-shadow:0 0 0 2px rgba(199,155,63,.95) inset,0 10px 22px rgba(184,148,62,.45);pointer-events:none}
.thumb[aria-selected="true"]::after{content:'';position:absolute;z-index:1;inset:0;border-radius:12px;background:radial-gradient(120% 60% at 15% 0%,rgba(255,255,255,.38) 0%,rgba(255,255,255,0) 60%);box-shadow:inset 0 0 0 3px rgba(224,192,102,.95);pointer-events:none}
.thumb[aria-selected="true"] .thumbImg{filter:saturate(1.08) contrast(1.06)}
@media (prefers-reduced-motion:no-preference){
  .thumb[aria-selected="true"]::before{animation:goldSheen 3s linear infinite}
  @keyframes goldSheen{0%{filter:hue-rotate(0deg) brightness(1)}50%{filter:hue-rotate(-8deg) brightness(1.06)}100%{filter:hue-rotate(0deg) brightness(1)}}
}
.note{margin:10px 0 20px 20px;font:600 12px 'Montserrat',sans-serif;color:#8a8f9a;visibility:hidden}
.toast{position:fixed;left:50%;bottom:40px;transform:translateX(-50%);background:rgba(255,255,255,.95);border:1px solid rgba(0,0,0,.1);border-radius:12px;padding:12px 22px;font:600 15px 'Montserrat',sans-serif;color:#000;box-shadow:0 4px 20px rgba(0,0,0,.15);opacity:0;pointer-events:none;transition:opacity .4s;z-index:9999}
.toast.show{opacity:1}
@media (max-width:1024px){.header-wrap{position:static;height:auto;padding:10px 16px;flex-wrap:wrap;row-gap:8px}.page{padding-top:24px}.grid{grid-template-columns:1fr;gap:24px}.signature{bottom:10px}}
@media (max-width:640px){body{font-size:14px}.brand svg{height:48px}.headerTexts{text-align:left;margin-top:6px}.title{font-size:18px}.toolbar{flex-direction:column;align-items:stretch}.signature{left:50%;transform:translateX(-50%);max-width:calc(100% - 20px);text-align:center}}
</style>
</head>
<body>
<header class="header-wrap">
  <div class="headerTexts">
    <h1 class="title">Studio TEST - By S.B</h1>
    <div class="subTitleSmall">Configuration monture • rendu photo-réaliste</div>
  </div>
</header>
<div class="page">
  <div class="wrap">
    <div class="grid">
      <div class="card">
        <div class="viewer" id="viewer">
          <div id="cvWrap">
            <canvas id="cv" width="2048" height="1265"></canvas>
          </div>
          <div class="model-label" id="modelLabel">—</div>
          <div class="loader-overlay" id="loaderOverlay"><div class="spinner"></div></div>
        </div>
        <div class="toolbar">
          <button class="btn3d" id="btnFav">❤ Favoris</button>
          <button class="btn3d" id="btnShare">⇪ Partager</button>
          <button class="btn3d" id="btnExport">⬇ Exporter</button>
        </div>
        <p class="note" id="driveNote">...</p>
      </div>
      <aside class="side">
        <div class="panel"><div class="panelHeader"><h2>Faces</h2></div><div id="galFaces" class="gal"></div></div>
        <div class="panel"><div class="panelHeader"><h2>Branches</h2></div><div id="galTemples" class="gal"></div></div>
        <div class="panel"><div class="panelHeader"><h2>Favoris</h2></div><div id="galFavs" class="gal"></div></div>
      </aside>
    </div>
  </div>
</div>
<div class="signature">
  Sébastien BOURDON<br>sb.optic1@gmail.com<br>06&nbsp;62&nbsp;71&nbsp;27&nbsp;52
  <div class="legal">© 2025 — Usage individuel uniquement</div>
</div>
<div id="toast" class="toast">⭐ Ajouté aux favoris</div>
<script>
const DRIVE={API_KEY:"AIzaSyAGTWwPZRyT6P8G2FlfeCRPnlADalQmE-0",FACES_FOLDER_ID:"1sYQqBv9T_CFFeJBS_9otKVz6Q1HONoBx",TEMPLES_FOLDER_ID:"1Uorpg-crCvjlAsYq4Lky2yGRxV2iWwEf",WORKER_URL:"https://berecllo-proxy1.sb-optic1.workers.dev",FACE_MASK_FILE_ID:"1kPVvpTxjyyYZhivVWLrgtG8yHzc8Qrj5",DIRECT_FALLBACK:!0,CONCURRENCY:3};
const cv=document.getElementById("cv"),ctx=cv.getContext("2d",{willReadFrequently:!0}),cvWrap=document.getElementById("cvWrap"),modelLabel=document.getElementById("modelLabel"),viewer=document.getElementById("viewer");
const galFaces=document.getElementById("galFaces"),galTemples=document.getElementById("galTemples"),galFavs=document.getElementById("galFavs");
const btnFav=document.getElementById("btnFav"),btnShare=document.getElementById("btnShare"),btnExport=document.getElementById("btnExport");
const driveNote=document.getElementById("driveNote"),toast=document.getElementById("toast"),loaderOverlay=document.getElementById("loaderOverlay");
const state={faces:[],temples:[],selFace:null,selTemples:null,favs:[],tol:60,zoomScale:1,dbReady:!1,dbFailed:!1,pendingDownloads:0};
let db; const DB_NAME="berecllo-store",DB_VER=5;
function openDB(){return new Promise((e,t)=>{try{const r=indexedDB.open(DB_NAME,DB_VER);r.onupgradeneeded=e=>{const t=e.target.result;t.objectStoreNames.contains("images")&&t.deleteObjectStore("images"),t.createObjectStore("images",{keyPath:"id"}),t.objectStoreNames.contains("meta")||t.createObjectStore("meta",{keyPath:"key"})},r.onsuccess=()=>{db=r.result,state.dbReady=!0,e(db)},r.onerror=()=>{state.dbFailed=!0,t(r.error)}}catch(e){state.dbFailed=!0,t(e)}})}
function idFor(e,t){return`${e}|${t}`}
function putImageRecord(e,t,r,a,n,o){return state.dbFailed||!state.dbReady||!db?Promise.resolve():new Promise(s=>{const l=db.transaction("images","readwrite");l.objectStore("images").put({id:idFor(e,t),name:t,type:e,blob:r,modified:a||null,thumbDataURL:n||null,textColor:o||null}),l.oncomplete=s})}
function deleteImageRecord(e,t){return state.dbFailed||!state.dbReady||!db?Promise.resolve():new Promise(r=>{const a=db.transaction("images","readwrite");a.objectStore("images").delete(idFor(e,t)),a.oncomplete=r})}
function getAllImages(){return state.dbFailed||!state.dbReady||!db?Promise.resolve([]):new Promise((e,t)=>{const r=db.transaction("images","readonly").objectStore("images").getAll();r.onsuccess=()=>e(r.result||[]),r.onerror=()=>t(r.error)})}
function saveMeta(e,t){return state.dbFailed||!state.dbReady||!db?Promise.resolve():new Promise(r=>{const a=db.transaction("meta","readwrite");a.objectStore("meta").put({key:e,value:t}),a.oncomplete=r})}
function loadMeta(e){return state.dbFailed||!state.dbReady||!db?Promise.resolve(null):new Promise(t=>{const r=db.transaction("meta","readonly").objectStore("meta").get(e);r.onsuccess=()=>t(r.result?r.result.value:null),r.onerror=()=>t(null)})}
function breathe(){return new Promise(e=>setTimeout(e,0))}
function imgFromBlob(e){return new Promise((t,r)=>{const a=new Image;a.onload=()=>t(a),a.onerror=r,a.src=URL.createObjectURL(e)})}
function faceLabel(e){return e.replace(/\.[^.]+$/,"").toUpperCase()}
function templesLabel(e){return e.replace(/\.[^.]+$/,"").toLowerCase()}
function slugifyForFilename(e){return(e||"berecllo").normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^\w\- ]+/g,"").replace(/\s+/g,"_").replace(/_+/g,"_").replace(/^_+|_+$/g,"")}
function apiDownloadURL(e){return"https://drive.google.com/uc?export=download&id="+encodeURIComponent(e)}
function proxyURL(e){return DRIVE.WORKER_URL+"?u="+encodeURIComponent(e)}
function apiListURL(e){return"https://www.googleapis.com/drive/v3/files?"+new URLSearchParams({key:DRIVE.API_KEY,q:`'${e}' in parents and trashed=false`,fields:"files(id,name,mimeType,modifiedTime)",pageSize:1e3}).toString()}
async function fetchJSONfallback(e){try{const t=await fetch(proxyURL(e),{mode:"cors",headers:{"Content-Type":"application/json"},cache:"no-store"});if(!t.ok)throw new Error("proxy json "+t.status);return await t.json()}catch(t){if(!DRIVE.DIRECT_FALLBACK)throw t;const r=await fetch(e,{mode:"cors",cache:"no-store"});if(!r.ok)throw new Error("direct json "+r.status);return await r.json()}}
async function fetchBLOBfallback(e){try{const t=await fetch(proxyURL(e),{mode:"cors",cache:"no-store"});if(!t.ok)throw new Error("proxy blob "+t.status);return await t.blob()}catch(t){if(!DRIVE.DIRECT_FALLBACK)throw t;const r=await fetch(e,{mode:"cors",cache:"no-store"});if(!r.ok)throw new Error("direct blob "+r.status);return await r.blob()}}
let faceMaskImg=null,faceMaskReady=!1,maskLoadingPromise=null;
function loadFaceMaskFromDrive(){DRIVE.FACE_MASK_FILE_ID&&(maskLoadingPromise=new Promise(async e=>{try{const t=await fetchBLOBfallback(apiDownloadURL(DRIVE.FACE_MASK_FILE_ID));faceMaskImg=await imgFromBlob(t),faceMaskReady=!0}catch(e){console.warn("Mask fail",e)}e()}))}
function removeBackgroundAuto(e,t){const r=e.naturalWidth||e.width,a=e.naturalHeight||e.height;if(faceMaskReady&&faceMaskImg){const t=document.createElement("canvas");t.width=r,t.height=a;const n=t.getContext("2d");n.clearRect(0,0,r,a),n.drawImage(e,0,0,r,a),n.globalCompositeOperation="destination-in",n.drawImage(faceMaskImg,0,0,r,a),n.globalCompositeOperation="source-over";const o=new Image;return o.src=t.toDataURL("image/png"),o}const n=document.createElement("canvas");n.width=r,n.height=a;const o=n.getContext("2d",{willReadFrequently:!0});o.drawImage(e,0,0);const s=o.getImageData(0,0,r,a),l=s.data,i=Math.floor(Math.min(r,a)*.03),c=10;let d=0,m=0,u=0,h=0;function f(e,t){const n=(t*r+e)*4;d+=l[n],m+=l[n+1],u+=l[n+2],h++}for(let e=0;e<=c;e++){const t=Math.floor(e*(r-1)/c),n=Math.floor(e*(a-1)/c);f(t,i),f(t,a-1-i),f(i,n),f(r-1-i,n)}d/=h,m/=h,u/=h;for(let e=0;e<l.length;e+=4){const r=l[e]-d,n=l[e+1]-m,o=l[e+2]-u;Math.sqrt(r*r+n*n+o*o)<t&&(l[e+3]=0)}o.putImageData(s,0,0);const p=new Image;return p.src=n.toDataURL("image/png"),p}
async function getProcessedFace(e,t,r){return e.proc?e.proc:(faceMaskReady||!maskLoadingPromise||await maskLoadingPromise,r||await breathe(),new Promise(async r=>{const a=removeBackgroundAuto(e.img,t);a.onload=()=>{e.proc=a,r(a)}}))}
function makeThumbInfo(e){const t=120,r=document.createElement("canvas");r.width=t,r.height=t;const a=r.getContext("2d",{willReadFrequently:!0}),n=e.naturalWidth||e.width,o=e.naturalHeight||e.height,s=n/o;let l,i,c,d;s>1?(d=o,c=o,l=(n-c)/2,i=0):(c=n,d=n,l=0,i=(o-d)/2),a.drawImage(e,l,i,c,d,0,0,t,t);const m=a.getImageData(0,0,t,t).data;let u=0,h=0,f=0,p=0;for(let e=0;e<m.length;e+=4)u+=m[e],h+=m[e+1],f+=m[e+2],p++;return{thumbDataURL:r.toDataURL("image/jpeg",.6),textColor:.299*(u/p)+.587*(h/p)+.114*(f/p)<140?"#fff":"#000"}}
function updateLabel(){const e=state.selFace?faceLabel(state.selFace.name):"",t=state.selTemples?templesLabel(state.selTemples.name):"";modelLabel.textContent=e&&t?`${e} - ${t}`:e||t||"—"}
async function redraw(){let e=!1;state.selFace&&!state.selFace.proc&&(e=!0,loaderOverlay.classList.add("active"),await getProcessedFace(state.selFace,state.tol,!0)),ctx.clearRect(0,0,cv.width,cv.height),state.selTemples?.img&&ctx.drawImage(state.selTemples.img,0,0,cv.width,cv.height),state.selFace?.proc&&ctx.drawImage(state.selFace.proc,0,0,cv.width,cv.height),updateLabel(),persistSelection().catch(()=>{}),e&&loaderOverlay.classList.remove("active")}
function selectAndRedraw(e,t){e?state.selFace=t:state.selTemples=t,redraw(),rebuildAllGalleries()}
async function processFaceQueue(){for(;;){const e=state.faces.find(e=>!e.proc&&state.selFace!==e);if(!e)break;await breathe(),await getProcessedFace(e,state.tol,!1),await breathe()}}
async function removeVariant(e,t){const r=e?state.faces:state.temples,a=r.findIndex(e=>e.name===t);a>=0&&(r.splice(a,1),e&&state.selFace?.name===t&&(state.selFace=null),!e&&state.selTemples?.name===t&&(state.selTemples=null)),await deleteImageRecord(e?"face":"temples",t),await persistLists(),redraw(),rebuildAllGalleries()}
function buildThumbEl(e,t){const r=document.createElement("div");r.className="thumb",r.setAttribute("aria-selected",(e?state.selFace===t:state.selTemples===t)?"true":"false");const a=document.createElement("div");a.className="thumbInnerBorder",r.appendChild(a);const n=document.createElement("div");n.className="thumbImg",t.thumbDataURL?n.style.backgroundImage=`url("${t.thumbDataURL}")`:n.style.backgroundColor="#f0f0f0",r.appendChild(n);const o=document.createElement("div");o.className="thumbLabel",o.style.color=t.textColor||"#000",o.textContent=e?faceLabel(t.name):templesLabel(t.name),r.appendChild(o);const s=document.createElement("div");return s.className="thumbClose",s.textContent="✕",s.onclick=r=>{r.stopPropagation(),removeVariant(e,t.name)},r.appendChild(s),r.onclick=()=>selectAndRedraw(e,t),r}
function sortList(e){e.sort((e,t)=>e.name.localeCompare(t.name,void 0,{numeric:!0,sensitivity:"base"}))}
function rebuildGallery(e,t,r){sortList(t),e.innerHTML="",t.forEach(t=>e.appendChild(buildThumbEl(r,t)))}
async function renderFavs(){galFavs.innerHTML="";for(const e of state.favs){const t=state.faces.find(t=>t.name===e.face),r=state.temples.find(t=>t.name===e.temples),a=document.createElement("div");a.className="thumb",a.setAttribute("aria-selected","false");const n=document.createElement("div");n.className="thumbInnerBorder",a.appendChild(n);const o=document.createElement("div");if(o.className="thumbImg",t&&r&&t.img&&r.img){const e=document.createElement("canvas");e.width=300,e.height=185;const a=e.getContext("2d");a.drawImage(r.img,0,0,300,185),a.drawImage(t.proc||t.img,0,0,300,185),o.style.backgroundImage=`url("${e.toDataURL()}")`}else t&&t.thumbDataURL?o.style.backgroundImage=`url("${t.thumbDataURL}")`:o.style.backgroundColor="#ccc";a.appendChild(o);const s=document.createElement("div");s.className="thumbLabel",s.style.color="#000",s.textContent=e.label,a.appendChild(s),a.onclick=()=>{t&&(state.selFace=t),r&&(state.selTemples=r),redraw(),rebuildAllGalleries()},galFavs.appendChild(a)}}
function rebuildAllGalleries(){rebuildGallery(galFaces,state.faces,!0),rebuildGallery(galTemples,state.temples,!1),renderFavs()}
function toastMsg(e){toast.textContent=e,toast.classList.add("show"),setTimeout(()=>toast.classList.remove("show"),1400)}
btnExport.onclick=()=>cv.toBlob(e=>{const t=document.createElement("a");t.href=URL.createObjectURL(e),t.download=slugifyForFilename(modelLabel.textContent)+".png",t.click()});
btnShare.onclick=()=>cv.toBlob(async e=>{const t=new File([e],slugifyForFilename(modelLabel.textContent)+".png",{type:"image/png"});navigator.canShare?.({files:[t]})&&async function(){try{await navigator.share({files:[t],title:"Berecllo"})}catch(e){}}()});
btnFav.onclick=async()=>{if(!state.selFace||!state.selTemples)return;const e=modelLabel.textContent;state.favs.find(e=>e.face===state.selFace.name&&e.temples===state.selTemples.name)||(state.favs.unshift({face:state.selFace.name,temples:state.selTemples.name,label:e}),state.favs.length>5&&state.favs.pop(),await saveMeta("favs",state.favs),renderFavs(),toastMsg("⭐ Ajouté"))};
async function persistLists(){await saveMeta("facesNames",state.faces.map(e=>e.name)),await saveMeta("templesNames",state.temples.map(e=>e.name))}
async function persistSelection(){await saveMeta("selection",{face:state.selFace?.name,temples:state.selTemples?.name})}
async function processInBatches(e,t,r){for(let a=0;a<e.length;a+=t){const n=e.slice(a,a+t);await Promise.all(n.map(r)),await breathe()}}
async function syncFolder(e,t,r){let a=[];try{a=(await fetchJSONfallback(apiListURL(t))).files||[]}catch(e){return void console.warn("List fail",e)}const n="face"===e?state.faces:state.temples,o=new Set(a.map(e=>e.name||e.id+".png"));let s=!1;for(let t=n.length-1;t>=0;t--)o.has(n[t].name)||(deleteImageRecord(e,n[t].name),n.splice(t,1),s=!0);s&&rebuildAllGalleries();let l=a.filter(e=>{const t=e.name||e.id+".png",r=n.find(e=>e.name===t);return!r||r.modified!==e.modifiedTime});state.pendingDownloads+=l.length,updateDriveNote(),r&&l.sort((e,t)=>(e.name||e.id+".png")===r?-1:1),await processInBatches(l,DRIVE.CONCURRENCY,async t=>{const r=t.name||t.id+".png";try{const a=await fetchBLOBfallback(apiDownloadURL(t.id));await integrateDriveFile(e,r,a,t.modifiedTime),"face"===e?rebuildGallery(galFaces,state.faces,!0):rebuildGallery(galTemples,state.temples,!1)}catch(e){console.warn("DL error",r)}state.pendingDownloads--,updateDriveNote()}),await persistLists()}
function updateDriveNote(){driveNote.textContent=state.pendingDownloads>0?`Chargement ${state.pendingDownloads}...`:""}
async function integrateDriveFile(e,t,r,a){const n=await imgFromBlob(r),{thumbDataURL:o,textColor:s}=makeThumbInfo(n),l={name:t,img:n,proc:null,modified:a,thumbDataURL:o,textColor:s};if("face"===e){const r=state.faces.findIndex(e=>e.name===t);r>=0?state.faces[r]=l:state.faces.push(l),state.selFace?.name===t&&(state.selFace=l,redraw())}else{const r=state.temples.findIndex(e=>e.name===t);r>=0?state.temples[r]=l:state.temples.push(l),state.selTemples?.name===t&&(state.selTemples=l,redraw())}putImageRecord(e,t,r,a,o,s).catch(()=>{})}
async function reloadFromIndexedDB(){const e=await getAllImages().catch(()=>[]),t=await loadMeta("facesNames")||[],r=await loadMeta("templesNames")||[],a=await loadMeta("selection")||{};state.favs=await loadMeta("favs")||[];const n={};for(const t of e)n[idFor(t.type,t.name)]=t;for(const e of t){const t=n[idFor("face",e)];if(!t)continue;const r=await imgFromBlob(t.blob);state.faces.push({name:e,img:r,proc:null,modified:t.modified,thumbDataURL:t.thumbDataURL,textColor:t.textColor})}for(const e of r){const t=n[idFor("temples",e)];if(!t)continue;const r=await imgFromBlob(t.blob);state.temples.push({name:e,img:r,modified:t.modified,thumbDataURL:t.thumbDataURL,textColor:t.textColor})}let o=null,s=null;return a.face&&(state.selFace=state.faces.find(e=>e.name===a.face),state.selFace||(o=a.face)),a.temples&&(state.selTemples=state.temples.find(e=>e.name===a.temples),state.selTemples||(s=a.temples)),rebuildAllGalleries(),redraw(),{prioFace:o,prioTemples:s}}
viewer.addEventListener("wheel",e=>{e.preventDefault(),state.zoomScale+=e.deltaY<0?.1:-.1,state.zoomScale=Math.min(Math.max(state.zoomScale,1),2.5),cvWrap.style.transform=`scale(${state.zoomScale})`},{passive:!1});
(async function(){await openDB().catch(console.error),loadFaceMaskFromDrive();const{prioFace:e,prioTemples:t}=await reloadFromIndexedDB();processFaceQueue(),Promise.all([syncFolder("face",DRIVE.FACES_FOLDER_ID,e),syncFolder("temples",DRIVE.TEMPLES_FOLDER_ID,t)]).then(()=>{console.log("Synchro terminée"),processFaceQueue()})})();
</script>
</body>
</html>
