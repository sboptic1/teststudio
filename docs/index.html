<!--
========================================================
  Studio Berecllo ‚Äî By S.B
  Code et design ¬© 2025 S√©bastien Bourdon
  Auteur : S√©bastien Bourdon (sb.optic1@gmail.com)
  Tous droits r√©serv√©s.

  Licence : Usage individuel et non commercial autoris√©.
  Redistribution, modification ou utilisation commerciale
  interdites sans autorisation √©crite de l‚Äôauteur.

  Version : stable 2025-11-04
========================================================
-->
<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Studio Berecllo ‚Äî By S.B</title>

<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect rx='12' ry='12' width='64' height='64' fill='%23000'/%3E%3Ctext x='50%25' y='54%25' dominant-baseline='middle' text-anchor='middle' fill='%23fff' font-family='Helvetica Neue' font-size='28' font-weight='300'%3EB%3C/text%3E%3C/svg%3E">

<!-- police interface boutons -->
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;600&display=swap" rel="stylesheet">
<!-- police Cinzel pour le titre -->
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;500&display=swap" rel="stylesheet">

<style>
:root{
  --headerH:95px;
  --border:#e6e8ee;
  --gold1:#fff4c2;
  --gold2:#f1d98a;
  --gold3:#e0c066;
  --gold4:#b8943e;
  --gold5:#f9e9ad;
}
*{box-sizing:border-box;}
body{
  margin:0;
  background:#f6f7fa;
  color:#111;
  font:15px/1.6 "Helvetica Neue",Helvetica,Arial,sans-serif;
}

/* HEADER (glossy blanc) */
.header-wrap{
  position:fixed;
  inset:0 0 auto 0;
  height:var(--headerH);
  background:radial-gradient(circle at 20% 20%, #ffffff 0%, #f9f9f9 60%, #f0f0f0 100%);
  border-bottom:1px solid rgba(224,192,102,.55);
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:0 24px;
  z-index:100;
  box-shadow:0 12px 32px rgba(0,0,0,.15), 0 2px 4px rgba(255,255,255,.8) inset;
}

/* bloc gauche (logo) */
.brand{
  display:flex;
  align-items:center;
  height:100%;
}
.brand a{
  display:flex;
  align-items:center;
  height:100%;
  text-decoration:none;
}
.brand svg{
  height:100px;
  width:auto;
  display:block;
}

/* bloc droit (titres) */
.headerTexts{
  text-align:right;
  color:#000;
}
.title{
  font-family:'Cinzel', serif;
  font-weight:400;
  font-size:22px;
  line-height:1.1;
  letter-spacing:.06em;
  color:#000;
  margin:0;
}
.subTitleSmall{
  font-size:12px;
  font-weight:500;
  color:#6b6b6b;
  letter-spacing:.08em;
  text-transform:uppercase;
  margin:4px 0 0 0;
}

/* PAGE LAYOUT */
.page{
  padding-top:calc(var(--headerH) + 10px);
  padding-bottom:60px;
}
.wrap{
  max-width:2000px;
  margin:0 40px;
  padding:0 24px;
}
.grid{
  display:grid;
  grid-template-columns:minmax(0,2.1fr) minmax(0,1.2fr);
  gap:24px;
  align-items:flex-start; /* pour que la colonne droite ne tire pas sur la hauteur de gauche */
}

@media(max-width:1200px){
  .grid{grid-template-columns:1fr;}
}

/* SIGNATURE (inclut mention licence discr√®te) */
.signature{
  position:fixed;
  left: 64px;
  bottom:1px;
  font:500 12px/1.4 "Helvetica Neue",Arial,sans-serif;
  color:#6b6b6b;
  background:rgba(255,255,255,.7);
  border:1px solid rgba(0,0,0,.08);
  border-radius:10px;
  box-shadow:0 8px 20px rgba(0,0,0,.08);
  backdrop-filter:blur(6px);
  padding:10px 14px;
  z-index:9999;
  text-align:left;
  max-width:240px;
  word-break:break-word;
}
.signature .legal{
  margin-top:6px;
  font-size:11px;
  color:#7a7a7a;
}

/* CARD PRINCIPALE */
.card{
  background:#fff;
  border:1px solid var(--border);
  border-radius:20px;
  box-shadow:0 12px 30px rgba(0,0,0,.06);
  display:flex;
  flex-direction:column;
}
.viewer{
  position:relative;
  aspect-ratio:2048/1265;
  width:100%;
  border-radius:20px 20px 0 0;
  overflow:hidden;
  background:#eef2f7;
  display:flex;
  align-items:center;
  justify-content:center;
  touch-action:none;
}
#cvWrap{
  position:relative;
  width:100%;
  height:100%;
  transform-origin:center center;
  display:flex;
  align-items:center;
  justify-content:center;
}
canvas#cv{
  width:100%;
  height:100%;
  display:block;
  background:#eef2f7;
}
.model-label{
  position:absolute;
  left:50%;
  bottom:20px;
  transform:translateX(-50%);
  padding:12px 18px;
  border-radius:14px;
  background:rgba(255,255,255,.96);
  border:1px solid rgba(0,0,0,.1);
  backdrop-filter:blur(6px);
  font:300 21px/1.2 "Helvetica Neue",sans-serif;
  letter-spacing:.12em;
  color:#0b0d10;
  box-shadow:0 10px 24px rgba(0,0,0,.12);
  white-space:nowrap;
  max-width:90%;
  overflow:hidden;
  text-overflow:ellipsis;
  text-align:center;
}

/* TOOLBAR */
.toolbar{
  border-top:1px solid var(--border);
  padding:16px 20px;
  display:flex;
  justify-content:flex-end;
  gap:12px;
  flex-wrap:wrap;
}
.btn3d{
  cursor:pointer;
  border:0;
  border-radius:12px;
  padding:12px 18px;
  font:600 15px/1.1 "Helvetica Neue",sans-serif;
  color:#111;
  background:#fff;
  position:relative;
  isolation:isolate;
  box-shadow:
     inset 0 1px 0 rgba(255,255,255,.9),
     0 6px 16px rgba(0,0,0,.08);
  transition:transform .1s,box-shadow .15s;
}
.btn3d::before{
  content:'';
  position:absolute;
  inset:0;
  border-radius:12px;
  padding:2px;
  background:conic-gradient(from 210deg,#dfe7f4,#a8b9d0,#6f87a6,#e9f0fb,#8aa3c7,#dfe7f4);
  -webkit-mask:linear-gradient(#000 0 0) content-box,linear-gradient(#000 0 0);
  -webkit-mask-composite:xor;
  mask-composite:exclude;
  pointer-events:none;
}
.btn3d:hover{
  transform:translateY(-1px);
  box-shadow:0 10px 26px rgba(0,0,0,.15);
}

/* PANNEAUX C√îT√â DROIT */
.side{
  display:flex;
  flex-direction:column;
  gap:16px;

  /* üî• hauteur max = hauteur de la fen√™tre - header - marges */
  max-height:calc(100vh - var(--headerH) - 40px);
  overflow-y:auto;          /* scroll vertical ind√©pendant */
  padding-right:4px;        /* un peu d‚Äôair pour la scrollbar */
}

.panel{
  background:#fff;
  border:1px solid var(--border);
  border-radius:18px;
  padding:16px 16px 20px;
  box-shadow:0 12px 30px rgba(0,0,0,.06);
}
.panelHeader{
  display:flex;
  align-items:center;
  justify-content:space-between;
  margin-bottom:10px;
}
.panelHeader h2{
  margin:0;
  font:600 18px/1 'Montserrat',sans-serif;
  color:#111;
  display:flex;
  align-items:center;
  gap:10px;
}

/* GALERIES */
.gal{
  display:grid;
  grid-template-columns:repeat(5, minmax(0, 1fr)); /* toujours 5 colonnes */
  gap:10px;

}
@media(min-width:1400px){
  .gal{grid-template-columns:repeat(5,1fr);}
}
@media(max-width:600px){
  .gal{grid-template-columns:repeat(2,1fr);}
}

/* VIGNETTE (thumb) */
.thumb{
  position:relative;
  width:100%;              /* occupe toute la largeur de sa colonne */
  aspect-ratio:1 / 1;      /* reste carr√©e */
  border-radius:14px;
  background:radial-gradient(circle at 0 0,#fff,#e2e8f0);
  box-shadow:
    0 10px 20px rgba(148,163,184,.55),
    0 0 0 1px rgba(148,163,184,.3) inset;
  overflow:hidden;
  cursor:pointer;
  transition:transform .16s,filter .16s;
  display:flex;
  align-items:center;
  justify-content:center;

}

.thumb:hover{
  transform:translateY(-2px);
  filter:brightness(1.05);
}

/* BORDURE DOR√âE GLOSSY ‚Äî √âTAT S√âLECTIONN√â */
.thumb[aria-selected="true"]{
  transform:translateY(-1px);
}
.thumb[aria-selected="true"]::after{
  content:'';
  position:absolute;
  inset:-2px;                  /* petit d√©bord pour effet chrome */
  border-radius:14px;
  padding:2px;
  background:
    conic-gradient(from 210deg,
      #fff8d8,
      #f7e2a6,
      #e8c874,
      #d3a84a,
      #f6de93,
      #fff8d8);
  -webkit-mask:linear-gradient(#000 0 0) content-box,linear-gradient(#000 0 0);
  -webkit-mask-composite:xor;
  mask-composite:exclude;
  box-shadow:
    0 0 0 2px rgba(224,192,102,.85) inset,
    0 10px 22px rgba(184,148,62,.45),
    0 2px 6px rgba(0,0,0,.08);
  pointer-events:none;
}
.thumb[aria-selected="true"] .thumbInnerBorder{
  box-shadow:none; /* on laisse la bordure glossy g√©rer l‚Äôeffet */
}

/* miniature carr√©e preview texture */
.thumbImg{
  position:absolute;
  inset:0;
  background-size:cover;
  background-position:center;
  background-repeat:no-repeat;
}

/* label + petite croix */
.thumbLabel{
  position:absolute;
  left:3px;
  bottom:3px;
  right:1px;
  font:600 14px/1.3 'Montserrat',sans-serif;
  letter-spacing:.06em;
  text-align:left;
  word-break:none;
  z-index:2;
  text-shadow:0 2px 4px rgba(0,0,0,.6);
  color:#000;
}
.thumbClose{
position:absolute;
  top:8px;
  right:8px;
  width:18px;
  height:18px;
  border-radius:2px;
  background:rgba(0,0,0,.55);
  color:#fff;
  font-size:10px;
  font-family:"Helvetica Neue",sans-serif;
  line-height:25px;
  text-align:center;
  font-weight:600;
  cursor:pointer;
  z-index:3;
  box-shadow:0 2px 4px rgba(0,0,0,.45);
  user-select:none;
}

/* NOTE (debug Drive) masqu√©e visuellement */
.note{
  margin:10px 0 20px 20px;
  font:600 12px 'Montserrat',sans-serif;
  color:#8a8f9a;
  visibility:hidden;
}

/* TOAST */
.toast{
  position:fixed;
  left:50%;
  bottom:40px;
  transform:translateX(-50%);
  background:rgba(255,255,255,.95);
  border:1px solid rgba(0,0,0,.1);
  border-radius:12px;
  padding:12px 22px;
  font:600 15px 'Montserrat',sans-serif;
  color:#000;
  box-shadow:0 4px 20px rgba(0,0,0,.15);
  opacity:0;
  pointer-events:none;
  transition:opacity .4s;
  z-index:9999;
}
.toast.show{opacity:1}
/* Neutralise l'ancien liser√© interne si pr√©sent */
.thumb .thumbInnerBorder{
  box-shadow:none !important;
}

/* S√©lection : BORDURE DOR√âE GLOSSY PLUS √âPAISSE (4‚Äì5px) */
.thumb[aria-selected="true"]{
  /* l√©ger lift */
  transform:translateY(-2px);
}

/* Anneau externe √©pais + chrome */
.thumb[aria-selected="true"]::before{
  content:'';
  position:absolute;
  z-index:2;
  inset:-5px;                         /* √©paisseur visible */
  border-radius:18px;
  padding:9px;                        /* ~5px d‚Äôanneau */
  background:
    conic-gradient(from 210deg,
      #fff9df, #f4e0a1, #e2c369, #c79b3f,
      #eacf86, #f7e9b7, #fff9df);
  -webkit-mask:linear-gradient(#000 0 0) content-box,linear-gradient(#000 0 0);
  -webkit-mask-composite:xor;
  mask-composite:exclude;
  box-shadow:
    0 0 0 2px rgba(199,155,63,.95) inset,
    0 10px 22px rgba(184,148,62,.45),
    0 3px 8px rgba(0,0,0,.18);
  border:0;
  pointer-events:none;
}

/* Lueur dor√©e interne + highlight glossy */
.thumb[aria-selected="true"]::after{
  content:'';
  position:absolute;
  z-index:1;
  inset:0;
  border-radius:12px;
  background:
    radial-gradient(120% 60% at 15% 0%, rgba(255,255,255,.38) 0%, rgba(255,255,255,0) 60%),
    radial-gradient(120% 60% at 85% 100%, rgba(255,215,120,.28) 0%, rgba(255,215,120,0) 60%);
  box-shadow:
    inset 0 0 0 3px rgba(224,192,102,.95),
    inset 0 2px 14px rgba(224,192,102,.55);
  pointer-events:none;
}

/* Petit boost visuel du contenu s√©lectionn√© */
.thumb[aria-selected="true"] .thumbImg{ filter:saturate(1.08) contrast(1.06); }
.thumb[aria-selected="true"] .thumbLabel{ text-shadow:0 2px 7px rgba(0,0,0,.75); }

/* Reflet subtil anim√© (d√©sactiv√© si r√©duction de motion) */
@media (prefers-reduced-motion: no-preference){
  .thumb[aria-selected="true"]::before{
    animation: goldSheen 3s linear infinite;
  }
  @keyframes goldSheen{
    0%   { filter:hue-rotate(0deg) brightness(1); }
    50%  { filter:hue-rotate(-8deg) brightness(1.06); }
    100% { filter:hue-rotate(0deg) brightness(1); }
  }
}

/* CROIX 20% PLUS PETITE ‚Äî on force la priorit√© */
.gal .thumb .thumbClose{
  width:16px !important;              /* ex 22px -> 16px (~-27%, plus visible que -20) */
  height:16px !important;
  line-height:16px !important;
  font-size:10px !important;
  border-radius:4px !important;
  top:8px !important;
  right:8px !important;
}

/* Au cas o√π une r√®gle plus forte ailleurs : version ultra-sp√©cifique */
.panel .gal .thumb .thumbClose{
  width:16px !important;
  height:16px !important;
  line-height:16px !important;
  font-size:10px !important;
}
/* ===============================
   Ajustements responsive
   =============================== */

/* Tablettes / petits laptops */
@media (max-width: 1024px) {

  /* le header arr√™te d'√™tre bloqu√© en haut, il respire un peu */
  .header-wrap{
    position: static;
    height: auto;
    padding: 10px 16px;
    flex-wrap: wrap;
    row-gap: 8px;
  }

  /* on enl√®ve le gros offset li√© au header fixe */
  .page{
    padding-top: 24px;
  }

  /* marges un peu r√©duites */
  .wrap{
    margin: 0 16px;
    padding: 0 8px;
  }

  /* colonne centrale + colonne droite passent l'une sous l'autre */
  .grid{
    grid-template-columns: 1fr;
    gap: 24px;
  }

  /* signature un peu remont√©e */
  .signature{
    bottom: 10px;
  }
}

/* Smartphones */
@media (max-width: 640px) {

  body{
    font-size: 14px;
  }

  .brand svg{
    height: 48px;
  }

  .headerTexts{
    text-align: left;
    margin-top: 6px;
  }

  .title{
    font-size: 18px;
  }

  .wrap{
    margin: 0 10px;
    padding: 0 4px;
  }

  /* toolbar en colonne, plus confortable au pouce */
  .toolbar{
    flex-direction: column;
    align-items: stretch;
  }
  .btn3d{
    width: 100%;
    justify-content: center;
  }

  /* signature centr√©e, √©vite qu‚Äôelle d√©passe de l‚Äô√©cran */
  .signature{
    left: 50%;
    transform: translateX(-50%);
    max-width: calc(100% - 20px);
    text-align: center;
  }
}

</style>
</head>
<body>

<!-- HEADER -->
<header class="header-wrap">
  <div class="brand">
  <a href="https://berecllo.fr/berecllo-lunettes-montures-engagees/espace-revendeurs/" 
     target="_blank" 
     rel="noopener noreferrer"
     aria-label="Berecllo ‚Äì Espace revendeurs">
    <svg xmlns="http://www.w3.org/2000/svg" id="Calque_1" version="1.1" viewBox="0 0 460 273.7">
      <defs>
        <style>
          .st0 { fill: #242422; }
        </style>
      </defs>
      <g>
        <path class="st0" d="M172.1,114.2c-9.5,0-17.7,5.6-24.5,16.9-6.1,9.9-9.1,19.9-9.1,29.9s.9,8.6,2.6,10.8c1.8,2.2,4.3,3.4,7.6,3.4,11.1,0,28.3-15,29.5-16.3,1.1-1.3.9-2.3.4-2.9-.5-.6-1.7-.8-2.7-.2-1,.7-10.5,7.4-13.5,8.8-2.3,1.1-4.4,1.6-6.3,1.6s-3.5-.7-4.6-2c-1.1-1.3-1.6-3.6-1.6-6.9s.2-4.7.6-7.2c8.9-4,14.7-6.8,17.4-8.3,5.4-3.2,9.2-6.2,11.3-9.2,2.1-2.9,3.2-5.9,3.2-9s-.9-5.2-2.6-6.8c-1.8-1.7-4.3-2.5-7.6-2.5ZM168.3,134.7c-3.8,3.9-9.4,7.5-17,10.9.9-5.3,2.4-10.6,4.6-15.7,1.5-3.5,3.3-6.1,5.5-7.9,1.6-1.3,3.3-2,5.1-2s3.1.6,4.1,1.8c1.1,1.2,1.6,2.8,1.6,4.8s-1.3,5.4-3.9,8.1Z"/>
        <path class="st0" d="M236.7,120.5c.9-.9,1.4-2,1.4-3.2s-.5-2.3-1.4-3.2c-.9-.9-2.1-1.4-3.5-1.4s-4.3,1.3-7.2,3.8c-6,5.3-11.3,11.7-16,19.1l3-12.6c.6-2.6.9-4.2.9-4.9s-.2-1.1-.7-1.5c-.5-.4-1.2-.6-2-.6-2.4,0-5.8,1.3-10.3,3.6-4.9,2.6-11.9,9.2-12.5,10-.7.9-.5,1.6.1,2,.6.5,1.7.4,2.3-.1.7-.5,5.2-4.8,6.7-5.8,1.4-1,2.5-1.4,3.2-1.4,1,0,1.5.6,1.5,1.7s-.2,1.8-.6,3.9c-1.8,8.3-3.9,17.1-6.2,26.4l-4.9,18.9h10.4l3.2-13.6c2.1-9.1,3.7-14.9,4.7-17.4,1-2.5,2.8-5.4,5.4-8.8,2.6-3.4,5-5.9,7.1-7.5,2.2-1.6,5-3,8.4-4.2,3.6-1.2,5.9-2.3,6.8-3.2Z"/>
        <path class="st0" d="M321.6,116.2c-1.8-1.3-4.4-2-7.9-2-5.5,0-10.5,1.6-14.9,4.8-5.6,4.2-10.4,10.1-14.3,18-3.9,7.8-5.9,15.4-5.9,22.8s.9,8.1,2.8,11c1.8,2.9,4.8,4.4,8.9,4.3,12.1-.1,26.6-13,28.4-14.6,1.9-1.7,1.6-3.3,1.2-3.8-.5-.7-1.8-1.1-2.8-.5-2.1,1.3-14.2,11.3-19.7,11.3s-4.1-.9-5.3-2.8c-1.7-2.4-2.6-5.9-2.6-10.3s1-12,3.1-18c2.1-6,4.2-10,6.5-12.1,2.3-2.1,4.5-3.1,6.8-3.1s4,.8,6.7,2.4c2.6,1.5,4.7,2.2,6.3,2.2s3-.5,3.9-1.4c.9-.9,1.4-2.1,1.4-3.5s-.9-3.5-2.7-4.8Z"/>
        <path class="st0" d="M437.9,119.6c-3-3.6-6.9-5.5-11.4-5.5-10.5,0-19.3,5.2-26.4,15.5-5.6,8.3-8.4,17.4-8.4,27.2s.2,3.4.5,5c-7.2,3.6-12.6,5.2-17.5,6-2.3.4-2-2.1-1.6-4,.1-.7,2-9.5,5.9-26.3l8-33.5c2.8-12,4.8-20.1,6.1-24.2,1.3-4.1,2.6-6.8,4.2-8,1.1-.9,2.8-1.4,4.9-1.4s8.9,1.1,10.7,1.1c2.9,0,7.3-2.5,7.3-7.1s-3.9-7.5-7.7-7.5c-6.7,0-9.4,5.2-15.5,8.8-6,3.6-10.7,8.7-14,15.2-2.1,4.3-4.8,12.8-7.9,25.5l-8.6,35.1c-1.8,7.5-3.2,13.5-4,18.1-9.3,5.2-15.7,7.1-21.5,8.1-2.3.4-2-2.1-1.6-4,.1-.7,2-9.5,5.9-26.3l8-33.5c2.8-12,4.8-20.1,6.1-24.2,1.2-4.1,2.6-6.8,4.2-8,1.1-.9,2.8-1.4,4.9-1.4s8.9,1.1,10.7,1.1c2.9,0,7.3-2.5,7.3-7.1s-3.9-7.5-7.7-7.5c-6.7,0-9.4,5.2-15.5,8.8-6,3.6-10.7,8.7-14,15.2-2.1,4.3-4.8,12.8-7.9,25.5l-8.6,35.1c-3.3,13.4-5,22.3-5,26.5s.5,3.9,1.6,5.2c1.1,1.3,2.4,1.9,4.1,1.9,9.9,0,20.9-5.7,28.1-9.6,0,1-.1,1.9-.1,2.6,0,2.2.5,3.9,1.6,5.2,1.1,1.3,2.4,1.9,4.1,1.9,9.2,0,19.3-4.9,26.5-8.7.7,1.4,1.6,2.7,2.6,3.8,3.1,3.3,7.1,4.9,12.1,4.9,8.1,0,15.9-4.1,23.1-12.4,7.3-8.2,10.9-17.6,10.9-27.9s-1.5-11.6-4.6-15.2ZM424.3,162.4c-3.2,4.9-6.8,7.3-10.7,7.3s-5-1.3-6.7-3.9c-2.3-3.5-3.4-8.3-3.4-14.4,0-10,1.9-17.8,5.6-23.5,3.7-5.7,7.6-8.5,11.5-8.5s5.2,1.5,7.1,4.5c1.9,3,2.8,8,2.8,15s-2.1,17.2-6.2,23.5Z"/>
        <path class="st0" d="M129.2,96.6c4.1-5.2,6.2-10.9,6.2-17.2s-1.9-9.8-5.6-13.7c-1.3-1.2-1.8-1.9-5.1-4.3-6-3.9-14.4-5.8-25.1-5.8s-27.6,3.1-39.6,9.3c-12,6.2-21.2,14.4-27.8,24.7-6.5,10.3-9.8,20.9-9.8,31.8s1.9,14.6,5.7,20c3.8,5.4,5.1,8.7,9.3,9,2.8.2,7.6-2.1,7.6-6.8,0-2.8-.9-6.6-6.7-7.8-2.4-.5-4.8-2.8-5.5-3.9-1.3-1.8-2.3-3.7-3-5.8-.7-2.1-1-4.4-1-6.9,0-9.1,3-18.1,8.9-27.1,6-9,14.3-16.3,24.9-22,10.7-5.6,21.9-8.4,33.7-8.4s14.6,1.7,18.8,5.1c4.2,3.4,6.3,7.9,6.3,13.4,0,7.9-2.9,14.8-8.7,20.6-5.8,5.8-14.5,8.7-26,8.7l5.7-22.2c1.6-5.5,2.2-8.2,4.5-15.8-9.3,1.5-16.4,2.6-24,3.9l-1.2,4.8c.8-.2,1.4-.3,2-.3,1.2,0,2.3.4,3.1,1.1.8.8,1.2,1.6,1.2,2.6s-.3,3.1-.9,5.5l-14.5,56.8c-2.5,9.9-5.3,16.2-8.2,19.1-2.9,2.9-7.8,4.5-14.6,4.9l-1.5,5.4c8.8.1,41.8-.1,46.5-.5,8.7-.7,17.1-2.1,25.1-6.2,8-4.1,14.1-9.3,18.3-15.6,4.1-6.3,6.2-12.9,6.2-20s-.9-8.1-2.7-11.4c-1.8-3.3-4.3-6.1-7.7-8.2-3.3-2.2-7.8-3.7-13.6-4.6,8.3-2.8,14.5-6.8,18.6-12ZM113.9,123.6c2.2,3.1,3.3,6.8,3.3,11.1,0,8.7-2.5,16.9-8.7,23.6-6.4,6.9-9.8,7.9-18.8,9.1-4.2.5-14.1.8-20-.6.9-2,7.9-21.7,10.5-31.8l5-19.7c9.9,0,16.7.6,20.2,1.9,3.5,1.2,6.4,3.4,8.6,6.5Z"/>
        <path class="st0" d="M263.1,114.2c-9.5,0-17.7,5.6-24.5,16.9-6.1,9.9-9.1,19.9-9.1,29.9s.9,8.6,2.6,10.8c1.8,2.2,4.3,3.4,7.6,3.4,11.1,0,28.3-15,29.5-16.3,1.1-1.3.9-2.3.4-2.9-.5-.6-1.7-.8-2.7-.2-1,.7-10.5,7.4-13.5,8.8-2.3,1.1-4.4,1.6-6.3,1.6s-3.5-.7-4.6-2c-1.1-1.3-1.6-3.6-1.6-6.9s.2-4.7.6-7.2c8.9-4,14.7-6.8,17.4-8.3,5.4-3.2,9.2-6.2,11.3-9.2,2.1-2.9,3.2-5.9,3.2-9s-.9-5.2-2.6-6.8c-1.8-1.7-4.3-2.5-7.6-2.5ZM259.3,134.7c-3.8,3.9-9.4,7.5-17,10.9.9-5.3,2.4-10.6,4.6-15.7,1.5-3.5,3.3-6.1,5.5-7.9,1.6-1.3,3.3-2,5.1-2s3.1.6,4.1,1.8c1.1,1.2,1.6,2.8,1.6,4.8s-1.3,5.4-3.9,8.1Z"/>
    <g xmlns="http://www.w3.org/2000/svg">
    <path class="st0" d="M53.8,234.7h-2.7s-2.4-6.1-2.4-6.1h-7.6l-2.4,6.1h-2.5s8.4-20.1,8.4-20.1h.6l8.6,20.1ZM47.9,226.8l-3.2-8.4-3.1,8.4h6.3Z"/>
    <path class="st0" d="M78.4,234.7h-3.1s-7.2-10-7.2-10v10h-2.4v-19.5h7c1.4,0,2.5.6,3.3,1.7.9,1.1,1.3,2.3,1.3,3.7s-.1,1.4-.4,2.1c-.2.6-.7,1.2-1.2,1.7-.6.5-1.3.9-2.1,1.1h-2.5s7.2,9.3,7.2,9.3ZM73.2,217.5c-.2,0-.5-.2-.7-.2-.2,0-.5,0-.7,0h-3.6v6.6h4.2c.8,0,1.5-.3,1.9-.9.5-.6.7-1.3.7-2.2s-.2-1.3-.5-1.9c-.3-.6-.8-1-1.4-1.3Z"/>
    <path class="st0" d="M103.3,217.2h-5.5v17.5h-2.4v-17.5h-5.5v-2.1h13.3v2.1Z"/>
    <path class="st0" d="M123.4,234.7h-2.2v-19.5h2.2v19.5Z"/>
    <path class="st0" d="M153.6,218.5l-2,1c-.2-.8-.6-1.5-1.4-2-.7-.5-1.5-.8-2.4-.8s-1.2.1-1.7.4c-.5.3-.9.7-1.2,1.3-.2.5-.3,1-.3,1.5,0,1.2.5,2.1,1.6,2.7l4.9,1.8c.9.5,1.6,1.2,2,2.1.5.9.7,1.8.7,2.8s-.2,1.7-.5,2.4c-.3.8-.8,1.5-1.5,2.1-1.2.9-2.5,1.3-4,1.3s-2.6-.3-3.7-1c-.6-.5-1.1-1-1.4-1.5-.3-.6-.6-1.3-.9-2.2l2.1-1.1c0,1.1.4,2,1.2,2.8.8.7,1.7,1.1,2.7,1.1s.8,0,1.2-.2c.4-.1.8-.3,1.2-.6.4-.3.7-.7.9-1.2.2-.5.3-1,.3-1.6,0-.8-.2-1.5-.6-1.9-.4-.4-.7-.7-.9-.8-.2-.1-.6-.4-1.3-.7l-3.3-1.2c-1-.5-1.8-1.1-2.4-1.9-.6-.8-.9-1.7-.9-2.8s0-.7.2-1.4c.1-.7.5-1.4,1.2-2.2s1.4-1.2,2.3-1.4c.8-.2,1.5-.3,2.2-.3s.5,0,.6,0,.6,0,1.2.2c.6.1,1.3.5,2.1,1.1.7.6,1.2,1.4,1.5,2.4Z"/>
    <path class="st0" d="M182.4,234.7h-2.7s-2.4-6.1-2.4-6.1h-7.6l-2.4,6.1h-2.5s8.4-20.1,8.4-20.1h.6l8.6,20.1ZM176.5,226.8l-3.2-8.4-3.1,8.4h6.3Z"/>
    <path class="st0" d="M208.1,235.1h-.5l-13.9-15.7v15.3h-2.1v-20h.5s13.8,15.7,13.8,15.7v-15.2h2.2v20Z"/>
    <path class="st0" d="M255.3,234.7h-9.4v-19.5h2.4v17.4h7v2.1Z"/>
    <path class="st0" d="M284.5,215.1v13.3c0,1.2-.4,2.3-1,3.3-.6,1.1-1.5,1.9-2.5,2.4-1.4.7-2.9,1-4.4,1s-2.9-.3-4.1-1c-1.2-.7-2-1.5-2.4-2.4-.4-.9-.7-1.6-.8-2.1-.1-.5-.2-.9-.2-1.3v-13.2h2.3v13.2c.1.9.4,1.7.8,2.5.4.7,1,1.3,1.7,1.7,1,.4,1.9.6,2.9.6s1.5-.1,2.1-.4c.7-.3,1.2-.6,1.7-1.2.5-.5.8-1.1,1.1-1.6.2-.5.4-1.1.4-1.6v-13.2h2.3Z"/>
    <path class="st0" d="M311,235.1h-.5l-13.9-15.7v15.3h-2.1v-20h.5s13.8,15.7,13.8,15.7v-15.2h2.2v20Z"/>
    <path class="st0" d="M333.1,234.7h-10.3v-19.5h10.3v2.1h-8v5.8h8v2h-8v7.5h8v2.1Z"/>
    <path class="st0" d="M360.5,217.2h-5.5v17.5h-2.4v-17.5h-5.5v-2.1h13.3v2.1Z"/>
    <path class="st0" d="M380.6,234.7h-2.2v-19.5h2.2v19.5Z"/>
    <path class="st0" d="M410.3,234.7h-10.3v-19.5h10.3v2.1h-8.1v5.8h8.1v2h-8.1v7.5h8.1v2.1Z"/>
    <path class="st0" d="M438.6,234.7h-3.1s-7.2-10-7.2-10v10h-2.4v-19.5h7c1.4,0,2.5.6,3.3,1.7.9,1.1,1.3,2.3,1.3,3.7s-.1,1.4-.4,2.1c-.2.6-.7,1.2-1.2,1.7-.6.5-1.3.9-2.1,1.1h-2.5s7.2,9.3,7.2,9.3ZM433.3,217.5c-.2,0-.5-.2-.7-.2-.2,0-.5,0-.7,0h-3.6v6.6h4.2c.8,0,1.5-.3,1.9-.9.5-.6.7-1.3.7-2.2s-.2-1.3-.5-1.9c-.3-.6-.8-1-1.4-1.3Z"/>
  <g xmlns="http://www.w3.org/2000/svg">
    <g>
      <path class="st0" d="M172.1,95.2h-2.6s-2.4-5.7-2.4-5.7h-7.3l-2.4,5.7h-2.4s8.1-19,8.1-19h.6l8.3,19ZM166.5,87.8l-3.1-8-3,8h6.1Z"/>
      <path class="st0" d="M195.1,78.7h-5.3v16.5h-2.3v-16.5h-5.3v-1.9h12.9v1.9Z"/>
      <path class="st0" d="M218.5,95.2h-10v-18.4h10v2h-7.8v5.5h7.8v1.9h-7.8v7.1h7.8v2Z"/>
      <path class="st0" d="M242.8,95.2h-9.1v-18.4h2.3v16.4h6.8v2Z"/>
      <path class="st0" d="M264.5,95.2h-2.2v-18.4h2.2v18.4Z"/>
      <path class="st0" d="M293.2,95.2h-10v-18.4h10v2h-7.8v5.5h7.8v1.9h-7.8v7.1h7.8v2Z"/>
      <path class="st0" d="M320.6,95.2h-3s-6.9-9.4-6.9-9.4v9.4h-2.3v-18.4h6.8c1.3,0,2.4.6,3.2,1.6s1.3,2.2,1.3,3.5-.1,1.3-.4,1.9c-.2.6-.6,1.1-1.2,1.6-.6.5-1.3.9-2,1.1h-2.4s6.9,8.7,6.9,8.7ZM315.6,79c-.2,0-.4-.2-.7-.2-.2,0-.5,0-.7,0h-3.5v6.2h4.1c.8,0,1.4-.3,1.9-.8.4-.6.7-1.2.7-2s-.2-1.3-.4-1.8c-.3-.5-.7-.9-1.3-1.2Z"/>
    </g>
    <path class="st0" d="M328.3,45.2l-1.7-1.5c-2.2-1.9-4.5-2.7-7-2.3-2,.3-3.9,1.4-5.6,2.4-.3.2-.7.4-1,.6-1.4.8-3.4,2.1-4.8,4.2-1.4,2.2-3,3.2-5.3,3.6-1.3.2-3.1.2-5,0h-.7c-1.1,0-2.3,0-3.6.2-2.4.4-4.6,1.1-7,2-.8.3-1.5.4-2.2.4-2.3,0-4.8-1-8-3.4-2.3-1.8-4.6-2.3-7-2.7-2-.3-4.6-2.1-7.8-5.2-1.7-1.6-3.2-4-4.8-6.4-.6-.9-1.2-1.9-1.9-2.8-.4-.6-.9-1.3-1.3-1.9-1.4-1.9-2.8-4-4-6.1-.8-1.6-2.3-4.2-4.8-3.8-1.6.3-2.6,1.6-3.4,2.8,0,0-.4.2-.6.3-.5.2-1,.5-1.6.9-.4.3-.7.6-1.2.8-1.3.9-2.9,2-3.9,4-1.1,2.2-1.9,4.6-2.8,7-.5,1.5-1,3-1.6,4.4-.6,1.4-1.1,2-1.2,2-.5.2-1.3.3-2.1.4-.5,0-1.1,0-1.6.2-.6.1-1.2.3-1.7.5,0,0,0,0,0,0-.3-.3-.8-1.3-1-1.8-.2-.5-.5-1-.7-1.5-1-1.9-3.2-2.9-5.8-2.9-.4,0-.7,0-1.1.1-1.7.3-3.1,1.1-4,2.2-.9,1.2-1.7,1.9-2.3,2.3-.6.3-1.3.7-1.9,1.1-1.9,1.1-4,2.3-5.8,2.4-.9,0-2.9-1.2-4.7-3.3-.3-.4-.6-.8-1-1.2-1.6-2-3.6-4.6-7.2-4.5-.3,0-.7,0-1.1.1l-1.1.2c-4.9.8-10.2,1.8-15.3,4.9-.5.3-1.1.5-1.9.6-.6,0-1.1.1-1.8.2-.6,0-1.4.1-2.1.2-1.5.2-3,.5-4.5.8-1.5.3-3.1.6-4.7.8-2.5.4-4.5.6-6.4.7-.7,0-1.4.1-2.2.2-2.2.3-4.2,1-6.2,1.8-1.1.4-2.4,1.3-2,3.2.7,2,2.6,1.3,3.6,1.2,1.9-.7,3.4-1.2,5.2-1.5.6,0,1.1-.1,1.7-.2,2-.1,4.2-.4,6.9-.8,1.6-.3,3.2-.6,4.8-.8,1.4-.3,2.9-.5,4.4-.8.6,0,1.2-.1,1.8-.2.7,0,1.4-.1,2.1-.2,1.4-.2,2.6-.6,3.6-1.2,4.4-2.6,9.1-3.5,13.6-4.3l1.1-.2c1.5-.2,2.2.4,4,2.7h0c.3.5.7.9,1,1.3,1.3,1.5,4.6,5,8.2,4.9h.2c.3,0,.7,0,1-.1,2.5-.4,4.7-1.7,6.9-2.9h0c.6-.4,1.1-.7,1.7-1,1.3-.7,2.5-1.8,3.8-3.6,0,0,.4-.3,1-.4.2,0,.3,0,.5,0,.9,0,1.6.3,1.7.5.2.4.4.8.6,1.2.9,1.9,2.3,4.9,5.7,4.4.3,0,.7-.2,1.1-.3.5-.2,1.3-.3,2-.3.5,0,1,0,1.6-.2.7-.1,1.4-.3,1.9-.5,2-.8,3.2-3.3,3.8-4.6.6-1.5,1.2-3.1,1.7-4.6h0c.7-2.3,1.5-4.5,2.5-6.4.4-.9,1.3-1.5,2.4-2.2.5-.3.9-.6,1.4-1,.1,0,.4-.2.6-.3.7-.3,1.7-.8,2.5-1.9.1.2.2.4.4.6,1.3,2.4,2.8,4.6,4.3,6.7.4.6.9,1.2,1.3,1.8.6.9,1.2,1.8,1.8,2.7,1.7,2.5,3.4,5.1,5.4,7.1,4,3.9,7.2,5.9,10.2,6.4,2.1.4,3.5.7,5.1,1.8,2.5,1.9,6.4,4.4,10.9,4.3.5,0,1,0,1.5-.1.7-.1,1.4-.3,2.1-.5,2.2-.8,4.2-1.5,6.2-1.8,1-.2,1.8-.2,2.6-.2h.7c2,.1,4.2.2,5.9-.1,3.6-.6,6.3-2.4,8.5-5.7.7-1,1.7-1.9,3.2-2.7.4-.2.8-.4,1.1-.7,1.4-.8,2.7-1.6,3.9-1.8.1,0,.3,0,.5,0,.9,0,1.8.4,2.8,1.3l1.7,1.6c5.4,4.9,14.8,12.5,16.4,13.4,1.4.7,2.4.3,2.9-.3.5-.6.8-1.8,0-2.8s-10.9-9.1-16.3-13.9Z"/>
    <g>
      <rect class="st0" x="37" y="195.5" width="401.7" height="1.8"/>
      <path class="st0" d="M439.1,197.7H36.6v-2.6h402.4v2.6ZM37.3,197h401v-1.1H37.3v1.1Z"/>
    </g>
    <path class="st0" d="M229.9,226.4c0,1.8-1.5,3.3-3.3,3.3s-3.3-1.5-3.3-3.3,1.5-3.3,3.3-3.3,3.3,1.5,3.3,3.3Z"/>
  </g>
</g>
    </svg>
  </a>
</div>

  <div class="headerTexts">
    <h1 class="title">Studio Berecllo - By S.B</h1>
    <div class="subTitleSmall">Configuration monture ‚Ä¢ rendu photo-r√©aliste</div>
  </div>
</header>

<!-- PAGE -->
<div class="page">
  <div class="wrap">
    <div class="grid">

      <!-- ZONE CENTRALE -->
      <div class="card">
        <div class="viewer" id="viewer">
          <div id="cvWrap">
            <canvas id="cv" width="2048" height="1265"></canvas>
          </div>
          <div class="model-label" id="modelLabel">‚Äî</div>
        </div>
        <div class="toolbar">
          <button class="btn3d" id="btnFav">‚ù§ Favoris</button>
          <button class="btn3d" id="btnShare">‚á™ Partager</button>
          <button class="btn3d" id="btnExport">‚¨á Exporter</button>
        </div>
        <p class="note" id="driveNote">...</p>
      </div>

      <!-- COLONNE DROITE -->
      <aside class="side">
        <div class="panel">
          <div class="panelHeader"><h2>Faces</h2></div>
          <div id="galFaces" class="gal"></div>
        </div>

        <div class="panel">
          <div class="panelHeader"><h2>Branches</h2></div>
          <div id="galTemples" class="gal"></div>
        </div>

        <div class="panel">
          <div class="panelHeader"><h2>Favoris</h2></div>
          <div id="galFavs" class="gal"></div>
        </div>
      </aside>

    </div>
  </div>
</div>

<!-- SIGNATURE BAS DROITE (avec mention de licence) -->
<div class="signature">
  S√©bastien BOURDON<br>
  sb.optic1@gmail.com<br>
  06&nbsp;62&nbsp;71&nbsp;27&nbsp;52
  <div class="legal">¬© 2025 ‚Äî Usage individuel uniquement</div>
</div>

<div id="toast" class="toast">‚≠ê Ajout√© aux favoris</div>
<script>
/* CONFIG DRIVE */
const DRIVE = {
  API_KEY: "AIzaSyAGTWwPZRyT6P8G2FlfeCRPnlADalQmE-0",
  FACES_FOLDER_ID:   "1sYQqBv9T_CFFeJBS_9otKVz6Q1HONoBx",
  TEMPLES_FOLDER_ID: "1Uorpg-crCvjlAsYq4Lky2yGRxV2iWwEf",
  WORKER_URL: "https://berecllo-proxy1.sb-optic1.workers.dev",

  // masque face PNG (fond transparent)
  FACE_MASK_FILE_ID: "1kPVvpTxjyyYZhivVWLrgtG8yHzc8Qrj5",
  DIRECT_FALLBACK: true
};

/* DOM */
const cv       = document.getElementById('cv');
const ctx      = cv.getContext('2d',{willReadFrequently:true});
const cvWrap   = document.getElementById('cvWrap');

const modelLabel = document.getElementById('modelLabel');

const viewer     = document.getElementById('viewer');
const galFaces   = document.getElementById('galFaces');
const galTemples = document.getElementById('galTemples');
const galFavs    = document.getElementById('galFavs');

const btnFav     = document.getElementById('btnFav');
const btnShare   = document.getElementById('btnShare');
const btnExport  = document.getElementById('btnExport');

const driveNote  = document.getElementById('driveNote');
const toast      = document.getElementById('toast');

/* STATE */
const state = {
  faces: [],
  temples: [],
  selFace: null,
  selTemples: null,
  favs: [],
  tol: 60,
  zoomScale: 1.0,
  dbReady:false,
  dbFailed:false
};

/* IndexedDB */
let db;
const DB_NAME='berecllo-store';
const DB_VER=4;

function openDB(){
  return new Promise((resolve,reject)=>{
    try{
      const req=indexedDB.open(DB_NAME,DB_VER);
      req.onupgradeneeded=e=>{
        const d=e.target.result;
        if(!d.objectStoreNames.contains('images')){
          d.createObjectStore('images',{keyPath:'id'});
        }
        if(!d.objectStoreNames.contains('meta')){
          d.createObjectStore('meta',{keyPath:'key'});
        }
      };
      req.onsuccess=()=>{
        db=req.result;
        state.dbReady=true;
        resolve(db);
      };
      req.onerror=()=>{
        state.dbFailed=true;
        reject(req.error||new Error("IndexedDB open error"));
      };
    }catch(err){
      state.dbFailed=true;
      reject(err);
    }
  });
}
function idFor(type,name){ return `${type}|${name}`; }

function putImageRecord(type,name,blob,modified,thumbDataURL,textColor){
  if(state.dbFailed||!state.dbReady||!db) return Promise.resolve();
  return new Promise((resolve,reject)=>{
    const tx=db.transaction('images','readwrite');
    tx.objectStore('images').put({
      id:idFor(type,name),
      name,
      type,
      blob,
      modified:modified||null,
      thumbDataURL:thumbDataURL||null,
      textColor:textColor||null
    });
    tx.oncomplete=()=>resolve();
    tx.onerror =()=>reject(tx.error||new Error("putImageRecord fail"));
  });
}
function deleteImageRecord(type,name){
  if(state.dbFailed||!state.dbReady||!db) return Promise.resolve();
  return new Promise((resolve,reject)=>{
    const tx=db.transaction('images','readwrite');
    tx.objectStore('images').delete(idFor(type,name));
    tx.oncomplete=()=>resolve();
    tx.onerror =()=>reject(tx.error||new Error("deleteImageRecord fail"));
  });
}
function getAllImages(){
  if(state.dbFailed||!state.dbReady||!db) return Promise.resolve([]);
  return new Promise((resolve,reject)=>{
    const tx=db.transaction('images','readonly');
    const r=tx.objectStore('images').getAll();
    r.onsuccess=()=>resolve(r.result||[]);
    r.onerror =()=>reject(r.error||new Error("getAllImages fail"));
  });
}
function saveMeta(key,val){
  if(state.dbFailed||!state.dbReady||!db) return Promise.resolve();
  return new Promise((resolve,reject)=>{
    const tx=db.transaction('meta','readwrite');
    tx.objectStore('meta').put({key,value:val});
    tx.oncomplete=()=>resolve();
    tx.onerror =()=>reject(tx.error||new Error("saveMeta fail"));
  });
}
function loadMeta(key){
  if(state.dbFailed||!state.dbReady||!db) return Promise.resolve(null);
  return new Promise((resolve,reject)=>{
    const tx=db.transaction('meta','readonly');
    const r=tx.objectStore('meta').get(key);
    r.onsuccess=()=>resolve(r.result?r.result.value:null);
    r.onerror =()=>reject(r.error||new Error("loadMeta fail"));
  });
}

/* utils image */
function imgFromBlob(blob){
  return new Promise((res,rej)=>{
    const img=new Image();
    img.onload=()=>res(img);
    img.onerror=(e)=>rej(e);
    img.src=URL.createObjectURL(blob);
  });
}

/* === MASQUE FACE PNG DEPUIS DRIVE === */

let faceMaskImg   = null;
let faceMaskReady = false;

function apiDownloadURL(id){
  return "https://drive.google.com/uc?export=download&id="+encodeURIComponent(id);
}
function proxyURL(u){ return DRIVE.WORKER_URL+"?u="+encodeURIComponent(u); }

async function fetchJSONfallback(url){
  try{
    const r=await fetch(proxyURL(url),{mode:"cors",headers:{"Content-Type":"application/json"},cache:"no-store"});
    if(!r.ok) throw new Error("proxy json "+r.status);
    return await r.json();
  }catch(e){
    if(!DRIVE.DIRECT_FALLBACK) throw e;
    const r2=await fetch(url,{mode:"cors",cache:"no-store"});
    if(!r2.ok) throw new Error("direct json "+r2.status);
    return await r2.json();
  }
}
async function fetchBLOBfallback(url){
  try{
    const r=await fetch(proxyURL(url),{mode:"cors",cache:"no-store"});
    if(!r.ok) throw new Error("proxy blob "+r.status);
    return await r.blob();
  }catch(e){
    if(!DRIVE.DIRECT_FALLBACK) throw e;
    const r2=await fetch(url,{mode:"cors",cache:"no-store"});
    if(!r2.ok) throw new Error("direct blob "+r2.status);
    return await r2.blob();
  }
}

async function loadFaceMaskFromDrive(){
  faceMaskImg=null;
  faceMaskReady=false;
  if(!DRIVE.FACE_MASK_FILE_ID){
    console.warn("FACE_MASK_FILE_ID non d√©fini");
    return;
  }
  try{
    const url  = apiDownloadURL(DRIVE.FACE_MASK_FILE_ID);
    const blob = await fetchBLOBfallback(url);
    const img  = await imgFromBlob(blob);
    faceMaskImg   = img;
    faceMaskReady = true;
    console.log("Masque face PNG charg√© depuis Drive :", img.naturalWidth+"x"+img.naturalHeight);
  }catch(e){
    console.warn("√âchec chargement masque face depuis Drive, fallback d√©tourage auto.",e);
  }
}

/* d√©tourage automatique + masque PNG */
function removeBackgroundAuto(img,tol){
  const w=img.naturalWidth||img.width;
  const h=img.naturalHeight||img.height;

  // 1) Si le masque PNG est pr√™t : on DECOUPE UNIQUEMENT AVEC LUI
  if(faceMaskReady && faceMaskImg){
    const c=document.createElement('canvas');
    c.width=w; c.height=h;
    const x=c.getContext('2d');

    x.clearRect(0,0,w,h);
    // face brute
    x.drawImage(img,0,0,w,h);

    // masque en destination-in (on garde uniquement la monture)
    x.globalCompositeOperation='destination-in';
    x.drawImage(faceMaskImg,0,0,w,h);
    x.globalCompositeOperation='source-over';

    const out=new Image();
    out.src=c.toDataURL('image/png');
    return out;
  }

  // 2) Sinon : on retombe sur ton d√©tourage auto d'origine
  const c=document.createElement('canvas');
  c.width=w; c.height=h;
  const x=c.getContext('2d',{willReadFrequently:true});
  x.drawImage(img,0,0);
  const data=x.getImageData(0,0,w,h);
  const d=data.data;

  const margin=Math.floor(Math.min(w,h)*0.03);
  const steps=10;
  let r=0,g=0,b=0,n=0;
  function pick(sx,sy){
    const o=(sy*w+sx)*4;
    r+=d[o]; g+=d[o+1]; b+=d[o+2]; n++;
  }
  for(let i=0;i<=steps;i++){
    const t=Math.floor(i*(w-1)/steps);
    const u=Math.floor(i*(h-1)/steps);
    pick(t,margin); pick(t,h-1-margin);
    pick(margin,u); pick(w-1-margin,u);
  }
  r/=n; g/=n; b/=n;

  for(let i=0;i<d.length;i+=4){
    const dr=d[i]-r, dg=d[i+1]-g, db=d[i+2]-b;
    const dist=Math.sqrt(dr*dr+dg*dg+db*db);
    if(dist<tol){
      d[i+3]=0;
    }
  }
  x.putImageData(data,0,0);
  const out=new Image();
  out.src=c.toDataURL('image/png');
  return out;
}

/* miniatures & labels */
function makeThumbInfo(img){
  const SIZE=200;
  const c=document.createElement('canvas');
  c.width=SIZE; c.height=SIZE;
  const x=c.getContext('2d');

  const iw=img.naturalWidth||img.width;
  const ih=img.naturalHeight||img.height;
  const ar=iw/ih;
  let sx,sy,sw,sh;
  if(ar>1){
    sh=ih; sw=ih; sx=(iw-sw)/2; sy=0;
  }else{
    sw=iw; sh=iw; sx=0; sy=(ih-sh)/2;
  }
  x.drawImage(img,sx,sy,sw,sh,0,0,SIZE,SIZE);

  const data=x.getImageData(0,0,SIZE,SIZE).data;
  let rr=0,gg=0,bb=0,n=0;
  for(let i=0;i<data.length;i+=4){
    rr+=data[i]; gg+=data[i+1]; bb+=data[i+2]; n++;
  }
  rr/=n; gg/=n; bb/=n;
  const lum = 0.299*rr+0.587*gg+0.114*bb;
  const textColor = lum<140 ? '#fff' : '#000';

  return {
    thumbDataURL:c.toDataURL('image/jpeg',0.8),
    textColor
  };
}

function faceLabel(n){ return n.replace(/\.[^.]+$/,'').toUpperCase(); }
function templesLabel(n){ return n.replace(/\.[^.]+$/,'').toLowerCase(); }

/* rendu principal */
function updateLabel(){
  const f=state.selFace    ? faceLabel(state.selFace.name)     : '';
  const t=state.selTemples ? templesLabel(state.selTemples.name): '';
  modelLabel.textContent = (f && t) ? `${f} - ${t}` : (f || t || '‚Äî');
}
function redraw(){
  ctx.clearRect(0,0,cv.width,cv.height);
  if(state.selTemples?.img){
    ctx.drawImage(state.selTemples.img,0,0,cv.width,cv.height);
  }
  if(state.selFace?.proc){
    ctx.drawImage(state.selFace.proc,0,0,cv.width,cv.height);
  }
  updateLabel();
  persistSelection().catch(()=>{});
}

/* s√©lection / suppression */
function selectAndRedraw(isFace,obj){
  if(isFace) state.selFace=obj;
  else       state.selTemples=obj;
  redraw();
  rebuildAllGalleries();
}

async function removeVariant(isFace,name){
  const list = isFace ? state.faces : state.temples;
  const idx=list.findIndex(x=>x.name===name);
  if(idx>=0){
    if(isFace && state.selFace && state.selFace.name===name){ state.selFace=null; }
    if(!isFace && state.selTemples && state.selTemples.name===name){ state.selTemples=null; }
    list.splice(idx,1);
  }
  const type=isFace?'face':'temples';
  await deleteImageRecord(type,name).catch(()=>{});

  await persistLists().catch(()=>{});
  redraw();
  rebuildAllGalleries();
}

/* Vignettes */
function buildThumbEl(isFace,obj){
  const wrap=document.createElement('div');
  wrap.className='thumb';
  wrap.setAttribute('aria-selected',
    (isFace ? state.selFace===obj : state.selTemples===obj) ? 'true':'false'
  );

  const border=document.createElement('div');
  border.className='thumbInnerBorder';
  wrap.appendChild(border);

  const imgDiv=document.createElement('div');
  imgDiv.className='thumbImg';
  if(obj.thumbDataURL){ imgDiv.style.backgroundImage=`url("${obj.thumbDataURL}")`; }
  else{ imgDiv.style.backgroundColor='#ddd'; }
  wrap.appendChild(imgDiv);

  const lbl=document.createElement('div');
  lbl.className='thumbLabel';
  lbl.style.color = obj.textColor || '#000';
  lbl.textContent = isFace? faceLabel(obj.name) : templesLabel(obj.name);
  wrap.appendChild(lbl);

  const close=document.createElement('div');
  close.className='thumbClose';
  close.textContent='‚úï';
  close.addEventListener('click',e=>{
    e.stopPropagation();
    removeVariant(isFace,obj.name);
  });
  wrap.appendChild(close);

  wrap.addEventListener('click',()=>{ selectAndRedraw(isFace,obj); });

  return wrap;
}

function rebuildGallery(dom,list,isFace){
  dom.innerHTML='';
  list.forEach(o=>{ dom.appendChild(buildThumbEl(isFace,o)); });
}
function renderFavs(){
  galFavs.innerHTML='';
  state.favs.forEach(fv=>{
    const fObj=state.faces.find(x=>x.name===fv.face);
    const wrap=document.createElement('div');
    wrap.className='thumb';
    wrap.setAttribute('aria-selected','false');

    const border=document.createElement('div');
    border.className='thumbInnerBorder';
    wrap.appendChild(border);

    const imgDiv=document.createElement('div');
    imgDiv.className='thumbImg';
    if(fObj && fObj.thumbDataURL){ imgDiv.style.backgroundImage=`url("${fObj.thumbDataURL}")`; }
    else{ imgDiv.style.backgroundColor='#ccc'; }
    wrap.appendChild(imgDiv);

    const lbl=document.createElement('div');
    lbl.className='thumbLabel';
    lbl.style.color = fObj?.textColor || '#000';
    lbl.textContent = fv.label;
    wrap.appendChild(lbl);

    wrap.addEventListener('click',()=>{
      const faceObj   = state.faces.find(x=>x.name===fv.face);
      const templObj  = state.temples.find(x=>x.name===fv.temples);
      if(faceObj)  state.selFace=faceObj;
      if(templObj) state.selTemples=templObj;
      redraw();
      rebuildAllGalleries();
    });

    galFavs.appendChild(wrap);
  });
}
function rebuildAllGalleries(){
  rebuildGallery(galFaces,state.faces,true);
  rebuildGallery(galTemples,state.temples,false);
  renderFavs();
}

/* Favoris / Export / Share */
function slugifyForFilename(s){
  return (s||'berecllo')
    .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
    .replace(/[^\w\- ]+/g,'')
    .replace(/\s+/g,'_')
    .replace(/_+/g,'_')
    .replace(/^_+|_+$/g,'');
}
function toastMsg(t){
  toast.textContent=t;
  toast.classList.add('show');
  setTimeout(()=>toast.classList.remove('show'),1400);
}

btnExport.onclick = ()=>cv.toBlob(b=>{
  const base=slugifyForFilename(modelLabel.textContent||'berecllo');
  const a=document.createElement('a');
  a.href=URL.createObjectURL(b);
  a.download=base+'.png';
  a.click();
});
btnShare.onclick = ()=>cv.toBlob(async b=>{
  const base=slugifyForFilename(modelLabel.textContent||'berecllo');
  const f=new File([b],base+'.png',{type:'image/png'});
  if(navigator.canShare && navigator.canShare({files:[f]})){
    try{
      await navigator.share({ files:[f], title:'Berecllo', text:modelLabel.textContent||'' });
    }catch(e){}
  }
});
btnFav.onclick = async ()=>{
  if(!state.selFace||!state.selTemples) return;
  const label=modelLabel.textContent;
  if(state.favs.find(x=>x.face===state.selFace.name && x.temples===state.selTemples.name)) return;
  state.favs.unshift({ face:state.selFace.name, temples:state.selTemples.name, label });
  if(state.favs.length>5) state.favs.pop();
  await saveMeta('favs',state.favs).catch(()=>{});
  renderFavs();
  toastMsg('‚≠ê Ajout√© aux favoris');
};

/* Persistance listes/s√©lection */
async function persistLists(){
  const fNames=state.faces.map(x=>x.name);
  const tNames=state.temples.map(x=>x.name);
  await saveMeta('facesNames',fNames).catch(()=>{});
  await saveMeta('templesNames',tNames).catch(()=>{});
}
async function persistSelection(){
  await saveMeta('selection',{
    face:state.selFace?.name||null,
    temples:state.selTemples?.name||null
  }).catch(()=>{});
}

/* reload cache local */
async function reloadFromIndexedDB(){
  const arr=await getAllImages().catch(()=>[]);
  const facesNames   = await loadMeta('facesNames').catch(()=>null) || [];
  const templesNames = await loadMeta('templesNames').catch(()=>null)|| [];
  const sel          = await loadMeta('selection').catch(()=>null) || {face:null,temples:null};
  const favs         = await loadMeta('favs').catch(()=>[]) || [];

  state.favs = favs.slice(0,5);

  const map={};
  for(const rec of arr){ map[idFor(rec.type,rec.name)] = rec; }

  const allFacesNames=[...new Set([...facesNames, ...arr.filter(x=>x.type==='face').map(x=>x.name)])];
  for(const nm of allFacesNames){
    const rec=map[idFor('face',nm)];
    if(!rec) continue;
    const img=await imgFromBlob(rec.blob);

    let thumbDataURL=rec.thumbDataURL;
    let textColor=rec.textColor;
    if(!thumbDataURL || !textColor){
      const tinfo=makeThumbInfo(img);
      thumbDataURL=tinfo.thumbDataURL;
      textColor=tinfo.textColor;
      await putImageRecord('face',nm,rec.blob,rec.modified,thumbDataURL,textColor).catch(()=>{});
    }

    const proc=removeBackgroundAuto(img,state.tol);
    const o={ name:nm, img, proc, modified:rec.modified||null, thumbDataURL, textColor };
    state.faces.push(o);
    proc.onload=()=>redraw();
  }

  const allTemplNames=[...new Set([...templesNames, ...arr.filter(x=>x.type==='temples').map(x=>x.name)])];
  for(const nm of allTemplNames){
    const rec=map[idFor('temples',nm)];
    if(!rec) continue;
    const img=await imgFromBlob(rec.blob);

    let thumbDataURL=rec.thumbDataURL;
    let textColor=rec.textColor;
    if(!thumbDataURL || !textColor){
      const tinfo=makeThumbInfo(img);
      thumbDataURL=tinfo.thumbDataURL;
      textColor=tinfo.textColor;
      await putImageRecord('temples',nm,rec.blob,rec.modified,thumbDataURL,textColor).catch(()=>{});
    }

    const o={ name:nm, img, modified:rec.modified||null, thumbDataURL, textColor };
    state.temples.push(o);
  }

  if(sel.face){
    const fo=state.faces.find(x=>x.name===sel.face);
    if(fo) state.selFace=fo;
  }
  if(sel.temples){
    const to=state.temples.find(x=>x.name===sel.temples);
    if(to) state.selTemples=to;
  }

  rebuildAllGalleries();
  redraw();
}

/* Drive helpers & sync */
function apiListURL(folderId){
  const base="https://www.googleapis.com/drive/v3/files";
  const q=new URLSearchParams({
    key:DRIVE.API_KEY,
    q:`'${folderId}' in parents and trashed=false`,
    fields:"files(id,name,mimeType,modifiedTime)",
    pageSize:1000,
    orderBy:"name"
  }).toString();
  return base+"?"+q;
}

async function syncFolder(type,folderId){
  driveNote.textContent="Synchro "+type+"‚Ä¶";
  let imgs;
  try{
    const url=apiListURL(folderId);
    const json=await fetchJSONfallback(url);
    imgs = json.files || [];
  }catch(err){
    console.error("Drive list fail",type,err);
    driveNote.textContent="";
    return;
  }

  const remoteNames = new Set(
    imgs.map(f => f.name || (f.id + ".png"))
  );

  const list = (type === 'face') ? state.faces : state.temples;
  const kept = [];

  for (const o of list){
    if (remoteNames.has(o.name)) {
      kept.push(o);
    } else {
      await deleteImageRecord(type, o.name).catch(()=>{});

      if (type === 'face' && state.selFace && state.selFace.name === o.name){
        state.selFace = null;
      }
      if (type === 'temples' && state.selTemples && state.selTemples.name === o.name){
        state.selTemples = null;
      }
    }
  }

  if (type === 'face') {
    state.faces = kept;
  } else {
    state.temples = kept;
  }

  for (const f of imgs){
    const name    = f.name || (f.id + ".png");
    const driveTs = f.modifiedTime || null;

    const currentList = (type === 'face') ? state.faces : state.temples;
    const existing    = currentList.find(x => x.name === name);

    if (existing && existing.modified === driveTs) {
      continue;
    }

    const dl = apiDownloadURL(f.id);

    let blob;
    try{
      blob = await fetchBLOBfallback(dl);
    }catch(err){
      console.warn("Drive blob fail", name, err);
      continue;
    }

    await integrateDriveFile(type, name, blob, driveTs);
  }

  await persistLists().catch(()=>{});
  rebuildAllGalleries();
  redraw();
  driveNote.textContent="";
}

/* int√©grer un fichier Drive */
async function integrateDriveFile(type,name,blob,driveTs){
  const baseImg=await imgFromBlob(blob);
  const {thumbDataURL,textColor}=makeThumbInfo(baseImg);

  let entry;
  if(type==="face"){
    const proc=removeBackgroundAuto(baseImg,state.tol);
    entry={ name, img:baseImg, proc, modified:driveTs||null, thumbDataURL, textColor };
    const i=state.faces.findIndex(x=>x.name===name);
    if(i>=0){ state.faces[i]=entry; } else { state.faces.push(entry); }
    proc.onload=()=>redraw();
  }else{
    entry={ name, img:baseImg, modified:driveTs||null, thumbDataURL, textColor };
    const i=state.temples.findIndex(x=>x.name===name);
    if(i>=0){ state.temples[i]=entry; } else { state.temples.push(entry); }
  }

  await putImageRecord(type,name,blob,driveTs,thumbDataURL,textColor).catch(()=>{});
}

/* Zoom molette */
const MIN_ZOOM=1.0;
const MAX_ZOOM=2.5;
viewer.addEventListener('wheel',e=>{
  e.preventDefault();
  state.zoomScale += (e.deltaY<0 ? 0.1 : -0.1);
  if(state.zoomScale<MIN_ZOOM) state.zoomScale=MIN_ZOOM;
  if(state.zoomScale>MAX_ZOOM) state.zoomScale=MAX_ZOOM;
  cvWrap.style.transform=`scale(${state.zoomScale})`;
},{passive:false});

/* BOOT */
(async function boot(){
  try{
    await openDB().catch(()=>{});
    await loadFaceMaskFromDrive().catch(()=>{});   // üî• masque d‚Äôabord
    await reloadFromIndexedDB().catch(()=>{});
    await syncFolder('temples',DRIVE.TEMPLES_FOLDER_ID);
    await syncFolder('face',   DRIVE.FACES_FOLDER_ID);
    driveNote.textContent="";
  }catch(e){
    console.error("BOOT ERROR",e);
    driveNote.textContent="";
  }
})();
</script>

<div id="toast" class="toast">‚≠ê Ajout√© aux favoris</div>

</body>
</html>
