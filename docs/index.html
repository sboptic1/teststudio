<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Studio TEST — By S.B</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="preconnect" href="https://drive.google.com">
<link rel="preconnect" href="https://content.googleapis.com">
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect rx='12' ry='12' width='64' height='64' fill='%23000'/%3E%3Ctext x='50%25' y='54%25' dominant-baseline='middle' text-anchor='middle' fill='%23fff' font-family='Helvetica Neue' font-size='28' font-weight='300'%3EB%3C/text%3E%3C/svg%3E">
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;600&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;500&display=swap" rel="stylesheet">
<style>:root{--headerH:95px;--border:#e6e8ee}*{box-sizing:border-box}body{margin:0;background:#f6f7fa;color:#111;font:15px/1.6 "Helvetica Neue",Helvetica,Arial,sans-serif}.header-wrap{position:fixed;inset:0 0 auto 0;height:var(--headerH);background:radial-gradient(circle at 20% 20%,#fff 0%,#f9f9f9 60%,#f0f0f0 100%);border-bottom:1px solid rgba(224,192,102,.55);display:flex;align-items:center;justify-content:space-between;padding:0 24px;z-index:100;box-shadow:0 12px 32px rgba(0,0,0,.15)}.brand,.brand a{display:flex;align-items:center;height:100%;text-decoration:none}.brand svg{height:100px;width:auto;display:block}.headerTexts{text-align:right;color:#000}.title{font-family:'Cinzel',serif;font-weight:400;font-size:22px;line-height:1.1;margin:0}.subTitleSmall{font-size:12px;font-weight:500;color:#6b6b6b;letter-spacing:.08em;text-transform:uppercase;margin:4px 0 0 0}.page{padding-top:calc(var(--headerH) + 10px);padding-bottom:60px}.wrap{max-width:2000px;margin:0 40px;padding:0 24px}.grid{display:grid;grid-template-columns:minmax(0,2.1fr) minmax(0,1.2fr);gap:24px;align-items:flex-start}@media(max-width:1200px){.grid{grid-template-columns:1fr}}.signature{position:fixed;left:64px;bottom:1px;font:500 12px/1.4 "Helvetica Neue",Arial,sans-serif;color:#6b6b6b;background:rgba(255,255,255,.7);border:1px solid rgba(0,0,0,.08);border-radius:10px;box-shadow:0 8px 20px rgba(0,0,0,.08);backdrop-filter:blur(6px);padding:10px 14px;z-index:9999;text-align:left;max-width:240px}.signature .legal{margin-top:6px;font-size:11px;color:#7a7a7a}.card{background:#fff;border:1px solid var(--border);border-radius:20px;box-shadow:0 12px 30px rgba(0,0,0,.06);display:flex;flex-direction:column}.viewer{position:relative;aspect-ratio:2048/1265;width:100%;border-radius:20px 20px 0 0;overflow:hidden;background:#eef2f7;display:flex;align-items:center;justify-content:center;touch-action:none}#cvWrap{position:relative;width:100%;height:100%;transform-origin:center center;display:flex;align-items:center;justify-content:center}canvas#cv{width:100%;height:100%;display:block;background:#eef2f7}.model-label{position:absolute;left:50%;bottom:20px;transform:translateX(-50%);padding:12px 18px;border-radius:14px;background:rgba(255,255,255,.96);border:1px solid rgba(0,0,0,.1);backdrop-filter:blur(6px);font:300 21px/1.2 "Helvetica Neue",sans-serif;letter-spacing:.12em;color:#0b0d10;box-shadow:0 10px 24px rgba(0,0,0,.12);white-space:nowrap;max-width:90%;overflow:hidden;text-overflow:ellipsis;text-align:center}.toolbar{border-top:1px solid var(--border);padding:16px 20px;display:flex;justify-content:flex-end;gap:12px;flex-wrap:wrap}.btn3d{cursor:pointer;border:0;border-radius:12px;padding:12px 18px;font:600 15px/1.1 "Helvetica Neue",sans-serif;color:#111;background:#fff;position:relative;isolation:isolate;box-shadow:inset 0 1px 0 rgba(255,255,255,.9),0 6px 16px rgba(0,0,0,.08);transition:transform .1s,box-shadow .15s}.btn3d::before{content:'';position:absolute;inset:0;border-radius:12px;padding:2px;background:conic-gradient(from 210deg,#dfe7f4,#a8b9d0,#6f87a6,#e9f0fb,#8aa3c7,#dfe7f4);-webkit-mask:linear-gradient(#000 0 0) content-box,linear-gradient(#000 0 0);-webkit-mask-composite:xor;mask-composite:exclude;pointer-events:none}.btn3d:hover{transform:translateY(-1px);box-shadow:0 10px 26px rgba(0,0,0,.15)}.side{display:flex;flex-direction:column;gap:16px;max-height:calc(100vh - var(--headerH) - 40px);overflow-y:auto;padding-right:4px}.panel{background:#fff;border:1px solid var(--border);border-radius:18px;padding:16px 16px 20px;box-shadow:0 12px 30px rgba(0,0,0,.06)}.panelHeader{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}.panelHeader h2{margin:0;font:600 18px/1 'Montserrat',sans-serif;color:#111}.gal{display:grid;grid-template-columns:repeat(5,minmax(0,1fr));gap:10px}@media(min-width:1400px){.gal{grid-template-columns:repeat(5,1fr)}}@media(max-width:600px){.gal{grid-template-columns:repeat(2,1fr)}}.thumb{position:relative;width:100%;aspect-ratio:1/1;border-radius:14px;background:radial-gradient(circle at 0 0,#fff,#e2e8f0);box-shadow:0 10px 20px rgba(148,163,184,.55),0 0 0 1px rgba(148,163,184,.3) inset;overflow:hidden;cursor:pointer;transition:transform .16s,filter .16s;display:flex;align-items:center;justify-content:center}.thumb:hover{transform:translateY(-2px);filter:brightness(1.05)}.thumbImg{position:absolute;inset:0;background-size:cover;background-position:center;background-repeat:no-repeat}.thumbLabel{position:absolute;left:3px;bottom:3px;right:1px;font:600 14px/1.3 'Montserrat',sans-serif;letter-spacing:.06em;text-align:left;z-index:2;text-shadow:0 2px 4px rgba(0,0,0,.6);color:#000}.thumbClose{position:absolute;top:8px;right:8px;width:16px;height:16px;border-radius:4px;background:rgba(0,0,0,.55);color:#fff;font-size:10px;line-height:16px;text-align:center;font-weight:600;cursor:pointer;z-index:3;box-shadow:0 2px 4px rgba(0,0,0,.45)}.thumb[aria-selected="true"]{transform:translateY(-2px)}.thumb[aria-selected="true"]::before{content:'';position:absolute;z-index:2;inset:-5px;border-radius:18px;padding:9px;background:conic-gradient(from 210deg,#fff9df,#f4e0a1,#e2c369,#c79b3f,#eacf86,#f7e9b7,#fff9df);-webkit-mask:linear-gradient(#000 0 0) content-box,linear-gradient(#000 0 0);-webkit-mask-composite:xor;mask-composite:exclude;box-shadow:0 0 0 2px rgba(199,155,63,.95) inset,0 10px 22px rgba(184,148,62,.45);pointer-events:none}.thumb[aria-selected="true"]::after{content:'';position:absolute;z-index:1;inset:0;border-radius:12px;background:radial-gradient(120% 60% at 15% 0%,rgba(255,255,255,.38) 0%,rgba(255,255,255,0) 60%);box-shadow:inset 0 0 0 3px rgba(224,192,102,.95);pointer-events:none}.thumb[aria-selected="true"] .thumbImg{filter:saturate(1.08) contrast(1.06)}@media(prefers-reduced-motion:no-preference){.thumb[aria-selected="true"]::before{animation:goldSheen 3s linear infinite}@keyframes goldSheen{0%{filter:hue-rotate(0deg) brightness(1)}50%{filter:hue-rotate(-8deg) brightness(1.06)}100%{filter:hue-rotate(0deg) brightness(1)}}}.note{margin:10px 0 20px 20px;font:600 12px 'Montserrat',sans-serif;color:#8a8f9a;visibility:hidden}.toast{position:fixed;left:50%;bottom:40px;transform:translateX(-50%);background:rgba(255,255,255,.95);border:1px solid rgba(0,0,0,.1);border-radius:12px;padding:12px 22px;font:600 15px 'Montserrat',sans-serif;color:#000;box-shadow:0 4px 20px rgba(0,0,0,.15);opacity:0;pointer-events:none;transition:opacity .4s;z-index:9999}.toast.show{opacity:1}@media(max-width:1024px){.header-wrap{position:static;height:auto;padding:10px 16px;flex-wrap:wrap;row-gap:8px}.page{padding-top:24px}.grid{grid-template-columns:1fr;gap:24px}.signature{bottom:10px}}@media(max-width:640px){body{font-size:14px}.brand svg{height:48px}.headerTexts{text-align:left;margin-top:6px}.title{font-size:18px}.toolbar{flex-direction:column;align-items:stretch}.signature{left:50%;transform:translateX(-50%);max-width:calc(100% - 20px);text-align:center}}</style>
</head>
<body>
<header class="header-wrap">
  <div class="brand">
    <a href="#">
      <svg viewBox="0 0 64 64"><rect rx="12" ry="12" width="64" height="64" fill="#000"/><text x="50%" y="54%" dominant-baseline="middle" text-anchor="middle" fill="#fff" font-family="Helvetica Neue" font-size="28" font-weight="300">B</text></svg>
    </a>
  </div>
  <div class="headerTexts">
    <h1 class="title">Studio TEST - By S.B</h1>
    <div class="subTitleSmall">Configuration monture • rendu photo-réaliste</div>
  </div>
</header>
<div class="page">
  <div class="wrap">
    <div class="grid">
      <div class="card">
        <div class="viewer" id="viewer">
          <div id="cvWrap"><canvas id="cv" width="2048" height="1265"></canvas></div>
          <div class="model-label" id="modelLabel">—</div>
        </div>
        <div class="toolbar">
          <button class="btn3d" id="btnFav">❤ Favoris</button>
          <button class="btn3d" id="btnShare">⇪ Partager</button>
          <button class="btn3d" id="btnExport">⬇ Exporter</button>
        </div>
        <p class="note" id="driveNote">...</p>
      </div>
      <aside class="side">
        <div class="panel"><div class="panelHeader"><h2>Faces</h2></div><div id="galFaces" class="gal"></div></div>
        <div class="panel"><div class="panelHeader"><h2>Branches</h2></div><div id="galTemples" class="gal"></div></div>
        <div class="panel"><div class="panelHeader"><h2>Favoris</h2></div><div id="galFavs" class="gal"></div></div>
      </aside>
    </div>
  </div>
</div>
<div class="signature">Sébastien BOURDON<br>sb.optic1@gmail.com<br>06&nbsp;62&nbsp;71&nbsp;27&nbsp;52<div class="legal">© 2025 — Usage individuel uniquement</div></div>
<div id="toast" class="toast">⭐ Ajouté aux favoris</div>
<script>
const DRIVE={API_KEY:"AIzaSyAGTWwPZRyT6P8G2FlfeCRPnlADalQmE-0",FACES_FOLDER_ID:"1sYQqBv9T_CFFeJBS_9otKVz6Q1HONoBx",TEMPLES_FOLDER_ID:"1Uorpg-crCvjlAsYq4Lky2yGRxV2iWwEf",WORKER_URL:"https://berecllo-proxy1.sb-optic1.workers.dev",FACE_MASK_FILE_ID:"1kPVvpTxjyyYZhivVWLrgtG8yHzc8Qrj5",DIRECT_FALLBACK:true,CONCURRENCY:5};
const cv=document.getElementById('cv');
const ctx=cv.getContext('2d',{willReadFrequently:true});
const cvWrap=document.getElementById('cvWrap');
const modelLabel=document.getElementById('modelLabel');
const viewer=document.getElementById('viewer');
const galFaces=document.getElementById('galFaces');
const galTemples=document.getElementById('galTemples');
const galFavs=document.getElementById('galFavs');
const btnFav=document.getElementById('btnFav');
const btnShare=document.getElementById('btnShare');
const btnExport=document.getElementById('btnExport');
const driveNote=document.getElementById('driveNote');
const toast=document.getElementById('toast');
const state={faces:[],temples:[],selFace:null,selTemples:null,favs:[],tol:60,zoomScale:1.0,dbReady:false,dbFailed:false};
let db;
const DB_NAME='berecllo-store';
const DB_VER=5;
function openDB(){return new Promise((resolve,reject)=>{try{const req=indexedDB.open(DB_NAME,DB_VER);req.onupgradeneeded=e=>{const d=e.target.result;if(!d.objectStoreNames.contains('images'))d.createObjectStore('images',{keyPath:'id'});if(!d.objectStoreNames.contains('meta'))d.createObjectStore('meta',{keyPath:'key'});};req.onsuccess=()=>{db=req.result;state.dbReady=true;resolve(db);};req.onerror=()=>{state.dbFailed=true;reject(req.error);};}catch(err){state.dbFailed=true;reject(err);}});}
function idFor(type,name){return `${type}|${name}`;}
function putImageRecord(type,name,blob,modified,thumbDataURL,textColor,procBlob){if(state.dbFailed||!state.dbReady||!db)return Promise.resolve();const tx=db.transaction('images','readwrite');const record={id:idFor(type,name),name,type,blob,modified:modified||null,thumbDataURL:thumbDataURL||null,textColor:textColor||null,procBlob:procBlob||null};tx.objectStore('images').put(record);return new Promise(r=>tx.oncomplete=r);}
function deleteImageRecord(type,name){if(state.dbFailed||!state.dbReady||!db)return Promise.resolve();const tx=db.transaction('images','readwrite');tx.objectStore('images').delete(idFor(type,name));return new Promise(r=>tx.oncomplete=r);}
function getAllImages(){if(state.dbFailed||!state.dbReady||!db)return Promise.resolve([]);return new Promise((resolve,reject)=>{const tx=db.transaction('images','readonly');const r=tx.objectStore('images').getAll();r.onsuccess=()=>resolve(r.result||[]);r.onerror=()=>reject(r.error);});}
function saveMeta(key,val){if(state.dbFailed||!state.dbReady||!db)return Promise.resolve();const tx=db.transaction('meta','readwrite');tx.objectStore('meta').put({key,value:val});return new Promise(r=>tx.oncomplete=r);}
function loadMeta(key){if(state.dbFailed||!state.dbReady||!db)return Promise.resolve(null);return new Promise(resolve=>{const tx=db.transaction('meta','readonly');const r=tx.objectStore('meta').get(key);r.onsuccess=()=>resolve(r.result?r.result.value:null);r.onerror=()=>resolve(null);});}
function breathe(){return new Promise(r=>setTimeout(r,0));}
function nextFrame(){return new Promise(r=>requestAnimationFrame(r));}
function imgFromBlob(blob){return new Promise((res,rej)=>{const img=new Image();img.onload=()=>res(img);img.onerror=rej;img.src=URL.createObjectURL(blob);});}
function faceLabel(n){return n.replace(/\.[^.]+$/,'').toUpperCase();}
function templesLabel(n){return n.replace(/\.[^.]+$/,'').toLowerCase();}
function slugifyForFilename(s){return (s||'berecllo').normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^\w\- ]+/g,'').replace(/\s+/g,'_').replace(/_+/g,'_').replace(/^_+|_+$/g,'');}
function apiDownloadURL(id){return "https://drive.google.com/uc?export=download&id="+encodeURIComponent(id);}
function proxyURL(u){return DRIVE.WORKER_URL+"?u="+encodeURIComponent(u);}
function apiListURL(folderId){const q=new URLSearchParams({key:DRIVE.API_KEY,q:`'${folderId}' in parents and trashed=false`,fields:"files(id,name,mimeType,modifiedTime)",pageSize:1000});return "https://www.googleapis.com/drive/v3/files?"+q.toString();}
async function fetchJSONfallback(url){try{const r=await fetch(proxyURL(url),{mode:"cors",headers:{"Content-Type":"application/json"},cache:"no-store"});if(!r.ok)throw new Error("proxy json "+r.status);return await r.json();}catch(e){if(!DRIVE.DIRECT_FALLBACK)throw e;const r2=await fetch(url,{mode:"cors",cache:"no-store"});if(!r2.ok)throw new Error("direct json "+r2.status);return await r2.json();}}
async function fetchBLOBfallback(url){try{const r=await fetch(proxyURL(url),{mode:"cors",cache:"no-store"});if(!r.ok)throw new Error("proxy blob "+r.status);return await r.blob();}catch(e){if(!DRIVE.DIRECT_FALLBACK)throw e;const r2=await fetch(url,{mode:"cors",cache:"no-store"});if(!r2.ok)throw new Error("direct blob "+r2.status);return await r2.blob();}}
let faceMaskImg=null, faceMaskReady=false;
async function loadFaceMaskFromDrive(){if(!DRIVE.FACE_MASK_FILE_ID)return;try{const blob=await fetchBLOBfallback(apiDownloadURL(DRIVE.FACE_MASK_FILE_ID));faceMaskImg=await imgFromBlob(blob);faceMaskReady=true;console.log("Masque chargé");}catch(e){console.warn("Mask fail",e);}}
async function removeBackgroundAutoAndCache(img,tol,name,originalBlob,originalRecord){if(originalRecord&&originalRecord.procBlob){try{const procImg=await imgFromBlob(originalRecord.procBlob);return procImg;}catch(e){}}const w=img.naturalWidth||img.width;const h=img.naturalHeight||img.height;const c=document.createElement('canvas');c.width=w;c.height=h;const x=c.getContext('2d',{willReadFrequently:true});if(faceMaskReady&&faceMaskImg){x.clearRect(0,0,w,h);x.drawImage(img,0,0,w,h);x.globalCompositeOperation='destination-in';x.drawImage(faceMaskImg,0,0,w,h);x.globalCompositeOperation='source-over';}else{x.drawImage(img,0,0);const data=x.getImageData(0,0,w,h);const d=data.data;const margin=Math.floor(Math.min(w,h)*0.03);const steps=10;let r=0,g=0,b=0,n=0;function pick(sx,sy){const o=(sy*w+sx)*4;r+=d[o];g+=d[o+1];b+=d[o+2];n++;}for(let i=0;i<=steps;i++){const t=Math.floor(i*(w-1)/steps);const u=Math.floor(i*(h-1)/steps);pick(t,margin);pick(t,h-1-margin);pick(margin,u);pick(w-1-margin,u);}r/=n;g/=n;b/=n;for(let i=0;i<d.length;i+=4){const dr=d[i]-r,dg=d[i+1]-g,db=d[i+2]-b;if(Math.sqrt(dr*dr+dg*dg+db*db)<tol)d[i+3]=0;}x.putImageData(data,0,0);}return new Promise(resolve=>{c.toBlob(blob=>{putImageRecord('face',name,originalBlob,originalRecord?.modified,originalRecord?.thumbDataURL,originalRecord?.textColor,blob);const finalImg=new Image();finalImg.onload=()=>resolve(finalImg);finalImg.src=URL.createObjectURL(blob);},'image/png');});}
function makeThumbInfo(img){const SIZE=200;const c=document.createElement('canvas');c.width=SIZE;c.height=SIZE;const x=c.getContext('2d');const iw=img.naturalWidth||img.width, ih=img.naturalHeight||img.height;const ar=iw/ih;let sx,sy,sw,sh;if(ar>1){sh=ih;sw=ih;sx=(iw-sw)/2;sy=0;}else{sw=iw;sh=iw;sx=0;sy=(ih-sh)/2;}x.drawImage(img,sx,sy,sw,sh,0,0,SIZE,SIZE);const data=x.getImageData(0,0,SIZE,SIZE).data;let rr=0,gg=0,bb=0,n=0;for(let i=0;i<data.length;i+=4){rr+=data[i];gg+=data[i+1];bb+=data[i+2];n++;}const lum=0.299*(rr/n)+0.587*(gg/n)+0.114*(bb/n);return {thumbDataURL:c.toDataURL('image/jpeg',0.8),textColor:lum<140?'#fff':'#000'};}
function updateLabel(){const f=state.selFace?faceLabel(state.selFace.name):'';const t=state.selTemples?templesLabel(state.selTemples.name):'';modelLabel.textContent=(f&&t)?`${f} - ${t}`:(f||t||'—');}
function redraw(){ctx.clearRect(0,0,cv.width,cv.height);if(state.selTemples?.img)ctx.drawImage(state.selTemples.img,0,0,cv.width,cv.height);if(state.selFace?.proc)ctx.drawImage(state.selFace.proc,0,0,cv.width,cv.height);updateLabel();persistSelection().catch(()=>{});}
function selectAndRedraw(isFace,obj){if(isFace)state.selFace=obj;else state.selTemples=obj;redraw();rebuildAllGalleries();}
async function removeVariant(isFace,name){const list=isFace?state.faces:state.temples;const idx=list.findIndex(x=>x.name===name);if(idx>=0){list.splice(idx,1);if(isFace&&state.selFace?.name===name)state.selFace=null;if(!isFace&&state.selTemples?.name===name)state.selTemples=null;}await deleteImageRecord(isFace?'face':'temples',name);await persistLists();redraw();rebuildAllGalleries();}
function buildThumbEl(isFace,obj){const wrap=document.createElement('div');wrap.className='thumb';wrap.setAttribute('aria-selected',(isFace?state.selFace===obj:state.selTemples===obj)?'true':'false');const b=document.createElement('div');b.className='thumbInnerBorder';wrap.appendChild(b);const d=document.createElement('div');d.className='thumbImg';if(obj.thumbDataURL)d.style.backgroundImage=`url("${obj.thumbDataURL}")`;else d.style.backgroundColor='#ddd';wrap.appendChild(d);const l=document.createElement('div');l.className='thumbLabel';l.style.color=obj.textColor||'#000';l.textContent=isFace?faceLabel(obj.name):templesLabel(obj.name);wrap.appendChild(l);const c=document.createElement('div');c.className='thumbClose';c.textContent='✕';c.onclick=(e)=>{e.stopPropagation();removeVariant(isFace,obj.name);};wrap.appendChild(c);wrap.onclick=()=>selectAndRedraw(isFace,obj);return wrap;}
function rebuildGallery(dom,list,isFace){dom.innerHTML='';list.sort((a,b)=>a.name.localeCompare(b.name,undefined,{numeric:true,sensitivity:'base'}));list.forEach(o=>dom.appendChild(buildThumbEl(isFace,o)));}
async function generateComboThumb(fObj,tObj){if(!fObj||!tObj)return null;const c=document.createElement('canvas');c.width=300;c.height=185;const x=c.getContext('2d');if(tObj.img)x.drawImage(tObj.img,0,0,300,185);if(fObj.proc)x.drawImage(fObj.proc,0,0,300,185);return c.toDataURL('image/jpeg',0.7);}
async function renderFavs(){galFavs.innerHTML='';for(const fv of state.favs){const fObj=state.faces.find(x=>x.name===fv.face);const tObj=state.temples.find(x=>x.name===fv.temples);const wrap=document.createElement('div');wrap.className='thumb';wrap.setAttribute('aria-selected','false');const b=document.createElement('div');b.className='thumbInnerBorder';wrap.appendChild(b);const d=document.createElement('div');d.className='thumbImg';if(fObj&&tObj){const comboUrl=await generateComboThumb(fObj,tObj);d.style.backgroundImage=`url("${comboUrl}")`;}else if(fObj&&fObj.thumbDataURL){d.style.backgroundImage=`url("${fObj.thumbDataURL}")`;}else{d.style.backgroundColor='#ccc';}wrap.appendChild(d);const l=document.createElement('div');l.className='thumbLabel';l.style.color='#000';l.textContent=fv.label;l.style.textShadow='0 2px 4px rgba(255,255,255,0.8)';wrap.appendChild(l);wrap.onclick=()=>{if(fObj)state.selFace=fObj;if(tObj)state.selTemples=tObj;redraw();rebuildAllGalleries();};galFavs.appendChild(wrap);}}
function rebuildAllGalleries(){rebuildGallery(galFaces,state.faces,true);rebuildGallery(galTemples,state.temples,false);renderFavs();}
function toastMsg(t){toast.textContent=t;toast.classList.add('show');setTimeout(()=>toast.classList.remove('show'),1400);}
btnExport.onclick=()=>cv.toBlob(b=>{const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download=slugifyForFilename(modelLabel.textContent)+'.png';a.click();});
btnShare.onclick=()=>cv.toBlob(async b=>{const f=new File([b],slugifyForFilename(modelLabel.textContent)+'.png',{type:'image/png'});if(navigator.canShare?.({files:[f]}))try{await navigator.share({files:[f],title:'Berecllo'});}catch(e){}});
btnFav.onclick=async()=>{if(!state.selFace||!state.selTemples)return;const lbl=modelLabel.textContent;if(state.favs.find(x=>x.face===state.selFace.name&&x.temples===state.selTemples.name))return;state.favs.unshift({face:state.selFace.name,temples:state.selTemples.name,label:lbl});if(state.favs.length>5)state.favs.pop();await saveMeta('favs',state.favs);renderFavs();toastMsg('⭐ Ajouté');};
async function persistLists(){await saveMeta('facesNames',state.faces.map(x=>x.name));await saveMeta('templesNames',state.temples.map(x=>x.name));}
async function persistSelection(){await saveMeta('selection',{face:state.selFace?.name,temples:state.selTemples?.name});}
async function processInBatches(items,batchSize,fn){for(let i=0;i<items.length;i+=batchSize){const batch=items.slice(i,i+batchSize);await Promise.all(batch.map(fn));await breathe();}}
async function syncFolder(type,folderId){driveNote.textContent=`Maj ${type==='face'?'Faces':'Branches'}...`;let files=[];try{const json=await fetchJSONfallback(apiListURL(folderId));files=json.files||[];}catch(e){console.warn("List fail",type);return;}const list=(type==='face')?state.faces:state.temples;const remoteNames=new Set(files.map(f=>f.name||(f.id+".png")));let hasDeleted=false;for(let i=list.length-1;i>=0;i--){if(!remoteNames.has(list[i].name)){const delName=list[i].name;list.splice(i,1);deleteImageRecord(type,delName);hasDeleted=true;}}if(hasDeleted)rebuildAllGalleries();const toDownload=files.filter(f=>{const name=f.name||(f.id+".png");const ex=list.find(x=>x.name===name);return !ex||ex.modified!==f.modifiedTime;});await processInBatches(toDownload,DRIVE.CONCURRENCY,async(f)=>{const name=f.name||(f.id+".png");try{const blob=await fetchBLOBfallback(apiDownloadURL(f.id));await integrateDriveFile(type,name,blob,f.modifiedTime);if(type==='face')rebuildGallery(galFaces,state.faces,true);else rebuildGallery(galTemples,state.temples,false);}catch(err){console.warn("DL error",name);}});await persistLists();driveNote.textContent="";}
async function integrateDriveFile(type,name,blob,modTime){const img=await imgFromBlob(blob);const {thumbDataURL,textColor}=makeThumbInfo(img);if(type==='face'){await breathe();const proc=await removeBackgroundAutoAndCache(img,state.tol,name,blob,{modified:modTime,thumbDataURL,textColor});const entry={name,img,proc,modified:modTime,thumbDataURL,textColor};const idx=state.faces.findIndex(x=>x.name===name);if(idx>=0)state.faces[idx]=entry;else state.faces.push(entry);proc.onload=()=>{if(state.selFace?.name===name)redraw();};}else{const entry={name,img,modified:modTime,thumbDataURL,textColor};const idx=state.temples.findIndex(x=>x.name===name);if(idx>=0)state.temples[idx]=entry;else state.temples.push(entry);putImageRecord(type,name,blob,modTime,thumbDataURL,textColor).catch(()=>{});}}
async function reloadFromIndexedDB(){const all=await getAllImages().catch(()=>[]);const fN=await loadMeta('facesNames')||[];const tN=await loadMeta('templesNames')||[];const sel=await loadMeta('selection')||{};state.favs=await loadMeta('favs')||[];const map={};for(const r of all)map[idFor(r.type,r.name)]=r;let selFaceRec=sel.face?map[idFor('face',sel.face)]:null;let selTempRec=sel.temples?map[idFor('temples',sel.temples)]:null;if(selFaceRec){const img=await imgFromBlob(selFaceRec.blob);const proc=await removeBackgroundAutoAndCache(img,state.tol,sel.face,selFaceRec.blob,selFaceRec);const entry={name:sel.face,img,proc,modified:selFaceRec.modified,thumbDataURL:selFaceRec.thumbDataURL,textColor:selFaceRec.textColor};state.faces.push(entry);state.selFace=entry;}if(selTempRec){const img=await imgFromBlob(selTempRec.blob);const entry={name:sel.temples,img,modified:selTempRec.modified,thumbDataURL:selTempRec.thumbDataURL,textColor:selTempRec.textColor};state.temples.push(entry);state.selTemples=entry;}if(state.selFace||state.selTemples)redraw();const loadOneFace=async(n)=>{if(state.faces.find(x=>x.name===n))return;const r=map[idFor('face',n)];if(!r)return;const img=await imgFromBlob(r.blob);if(!r.thumbDataURL){const t=makeThumbInfo(img);r.thumbDataURL=t.thumbDataURL;r.textColor=t.textColor;}const proc=await removeBackgroundAutoAndCache(img,state.tol,n,r.blob,r);state.faces.push({name:n,img,proc,modified:r.modified,thumbDataURL:r.thumbDataURL,textColor:r.textColor});};const loadOneTemple=async(n)=>{if(state.temples.find(x=>x.name===n))return;const r=map[idFor('temples',n)];if(!r)return;const img=await imgFromBlob(r.blob);if(!r.thumbDataURL){const t=makeThumbInfo(img);r.thumbDataURL=t.thumbDataURL;r.textColor=t.textColor;}state.temples.push({name:n,img,modified:r.modified,thumbDataURL:r.thumbDataURL,textColor:r.textColor});};(async()=>{for(const n of tN){await loadOneTemple(n);}rebuildGallery(galTemples,state.temples,false);for(const n of fN){await loadOneFace(n);if(state.faces.length%3===0){rebuildGallery(galFaces,state.faces,true);await nextFrame();}}rebuildAllGalleries();})();}
viewer.addEventListener('wheel',e=>{e.preventDefault();state.zoomScale+=(e.deltaY<0?0.1:-0.1);state.zoomScale=Math.min(Math.max(state.zoomScale,1.0),2.5);cvWrap.style.transform=`scale(${state.zoomScale})`;},{passive:false});
(async function boot(){await openDB().catch(console.error);loadFaceMaskFromDrive();await reloadFromIndexedDB();Promise.all([syncFolder('temples',DRIVE.TEMPLES_FOLDER_ID),syncFolder('face',DRIVE.FACES_FOLDER_ID)]).then(()=>console.log("Synchro terminée"));})();
</script>
</body>
</html>
